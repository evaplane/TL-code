
<div class="form-horizontal">
    <div class="form_rightBtn">
        <div class="pull-right"><button class="btn btn-primary" onclick="_add_fileBox()">创建文件夹</button></div>
    </div>
    <form class="form-horizontal" name="add_form" role="form"  id="add_form">
    <div class="uploadFileBox col-sm-12">
        <div class="uploadFileBox_left  col-xs-5 col-sm-5">
            <h2>服务器文件夹目录</h2>
            <div class="uploadFileBox_left_main  col-sm-12">
                <label class="uploadFile_radioZ">
                    <input type="radio" class="add_video_0" id="add_video_0" value="add_video_0" name="add_video"><span id="add_folder_0"></span>
                </label>
                <div class="uploadFile_leftList" id="add_uploadFile_leftList"></div>
            </div>
        </div>

        <div class="uploadFileBox_right col-xs-7 col-sm-7">
            <div class="form-group">
                <label class="control-label col-xs-4 col-sm-3"><span class="red">*</span>文件上传地址：</label>
                <div class="col-xs-8 col-sm-8">
                    <input type="text" class="form-control" id="folderUrl" name="folderUrl" placeholder="请输入文件上传地址" readonly autocomplete="off">
                </div>
            </div>
            <div class="form-group">
                <form enctype="multipart/form-data">
                    <label class="control-label col-xs-4 col-sm-3"><span class="red">*</span>上传文件：</label>
                    <div class="col-xs-8 col-sm-9">
                        <input type="file" name="file-folder" id="file-folder" style="display:none" multiple class="file-loading">
                        <input class="btn-dr btn btn-primary marginTop" id="add_fileUploadBtn" type="button" value="上传" onclick="fileUploadClick();">
                    </div>
                </form>
            </div>

            <div class="form-group uploadFolderMainListTit_Cont">
                <div class="col-xs-12 col-sm-12">
                    <h3 class="uploadFolderMainListTit">本次上传文件列表</h3>
                    <div class="uploadFolderMainList" id="uploadFolderMainList"></div>
                </div>
            </div>

        </div>
    </div>
    </form>
</div>

<div class="modal-footer" style="padding-bottom: 0;overflow: hidden;">
    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
    <button type="button" class="btn btn-primary" id="submit" onclick="_doSubmit()">提交</button>
</div>

<div class="loading_box">
    <img src="../../img/loder.gif" />
    <p>文件上传中...</p>
</div>

<script type="text/javascript">
    $(function() {
        baseFolder();
    });
    var testStr = 1;
    var indexStr = 1;
    function baseFolder() {
        $.ajax({
            type: 'GET',
            url: host_url + "/cms/baseFolder?_sys_login_token="+login_token(),
            cache: false, //清楚ie缓存
            dataType: 'json',
            success: function (res) {
                if (res.retCode == "000000") {
                    var data = res.rows;
                    $("#add_video_0").attr("filePath",data.filePath);
                    $("#add_folder_0").html(data.fileName);
                    var fileNameList = data.nodes;
                    var add_videoListID = "uploadFile_leftListDel_" + testStr;
                    var add_videoID = "add_video_" + indexStr;
                    var str = "";
                    $("#add_uploadFile_leftList").html("");
                    $.each(fileNameList,function(i,item){

                        if(item.fileType == 2){
                            str += '<div class="uploadFile_leftMainListStr">';
                            str += '<div class="uploadFile_leftListDel" id="' + add_videoListID + '">';
                            str += '<label class="uploadFile_radioZ col-lg-8">';
                            str += '<input type="radio" class="' + add_videoID + '" id="' + add_videoID + '" name="add_video" filePath="'+item.filePath+'"><span>' + item.fileName + '</span></label>';
                            str += '<i class="glyphicon glyphicon-trash"></i>';
                            str += '</div>';
                            var fileNameList2 = item.nodes;
                            console.log(fileNameList2);
                            if(fileNameList2=="" || fileNameList2==null || fileNameList2=="null"){
                            }else{
                                $.each(fileNameList2,function(j,item2){
                                    if(item2.fileType == 2){
                                        str += '<div class="uploadFile_leftListDel uploadFile_leftListDel2" id="' + add_videoListID + '">';
                                        str += '<label class="uploadFile_radioZ col-lg-8">';
                                        str += '<input type="radio" class="' + add_videoID + '" id="' + add_videoID + '" name="add_video" filePath="'+item2.filePath+'" fileName="'+item2.fileName+'"><span>' + item2.fileName + '</span></label>';
                                        str += '<i class="glyphicon glyphicon-trash"></i>';
                                        str += '</div>';
                                    }
                                });
                            }
                            str += '</div>';
                        }
                    })
                    $("#add_uploadFile_leftList").append(str);
                }else if (res.retCode == '401') {
                    Ewin.alert({message: "会话超时，请重新登录"}).on(function (e) {
                        if (e) {
                            window.location.href = "../login.html";
                            return;
                        }
                    });
                }else {
                    Ewin.alert({
                        message: res.retMsg
                    });
                    return false;
                }
            },
            error: function () {
                Ewin.alert({
                    message: "服务器错误!"
                });
                return false;
            }
        });
    }

    //创建文件夹
    function _add_fileBox() {
        var checked = $('.uploadFileBox_left_main input[type=radio]:checked');
        if (checked.length <= 0) {
            Ewin.alert({
                message: '请先选择创建文件夹的上级目录!'
            });
            return false;
        }else{
            Ewin.dialog({
                url: 'addFolder.html',
                title: '创建文件夹',
                width: 800,
                height: 600,
            });
        }
    }


    $(".form-horizontal").on("click",".uploadFile_leftListDel i",function(event){
        event.stopPropagation();
        var folderPath = $(this).parent().find("input[name='add_video']").attr("filepath");
        var fileName = $(this).parent().find("input[name='add_video']").attr("fileName");
        var _this =  $(this).parent();
        Ewin.confirm({
            message: '删除文件夹,该文件夹下所有文件将一起删除,是否确认？'
        }).on(function(e) {
            if (e) {
                var params = {
                    folderPath: folderPath,
                    _sys_login_token:login_token()
                }
                sendAjax('POST', host_url + "/cms/delFolder", params, function(res) {
                    if (res.retCode == "000000") {
                        Ewin.alert({
                            message: "删除成功!"
                        });
                        _this.remove();
                        baseFolder();
                        $("#uploadFolderMainList span[fileName='"+fileName+"']").remove();
                    }else {
                        Ewin.alert({
                            message: res.retMsg
                        });
                        return false;
                    }
                    $(".table").bootstrapTable('refresh');
                });
            }
        });

    })

    //-----------------删除一行，根据行ID删除-start--------
    function delAddRadioNum(add_videoListID) {
        Ewin.confirm({
            message: '删除文件夹,该文件夹下所有文件将一起删除,是否确认？'
        }).on(function(e) {
            if (e) {
                var folderPath = $(this).parent().find("input[name='add_video']").attr("filepath");
                alert(folderPath);
                if (folderPath == "") {
                    Ewin.alert({
                        message: "文件夹路径不能为空!"
                    });
                    return false;
                }
                var params = {
                    folderPath: folderPath,
                    _sys_login_token:login_token()
                }
                sendAjax('POST', host_url + "/cms/delFolder", params, function(res) {
                    if (res.retCode == "000000") {
                        Ewin.alert({
                            message: "删除成功!"
                        });
                        $("#" + add_videoListID).remove();
                        baseFolder();
                    }else {
                        Ewin.alert({
                            message: res.retMsg
                        });
                        return false;
                    }
                    // $(".table").bootstrapTable('refresh');
                });
            }
        });
    }

    fileUpload();

    //文件上传
    function fileUpload() {
        //文件导入
        var arrJson = [];
        var result = "";
        var str = '';
        var test = document.getElementById('file-folder');
        test.addEventListener('change', function() {
            $("#add_fileUploadBtn,#submit").attr("disabled",true);
            $(".loading_box").show();
            var t_files = this.files;
            var arr = [];
            for (var i = 0; i < t_files.length; i++) {    //读取文件名称       
                arrJson.push(t_files[i]);
                arr.push(t_files[i].name);      //读取文件内容       
            }
            var urlStr = $("#folderUrl").val();
            var fileName = $("#folderUrl").attr('fileName');
            var uploadFileName = $(".uploadFileBox_left_main").find("input:checked").next("span").text();
            for (var i = 0;i < arr.length; i++) {
                str += '<span class="col-xs-5 col-sm-5" fileUrl="'+urlStr+'" fileName="'+fileName+'">' + arr[i] + '，</span>'
            }
            $("#uploadFolderMainList").html("");
            $("#uploadFolderMainList").append(str);

            var url = host_url + "/file/uploadFiles"; // 接收上传文件的后台地址
            var form_Data = new FormData(); // FormData 对象
            for (i = 0; i < t_files.length; i++) {
                form_Data.append("file", t_files[i]);
            }
            var folderUrl = $("#folderUrl").val();
            form_Data.append("filePath", folderUrl);
            form_Data.append("_sys_login_token", login_token());
            xhr = new XMLHttpRequest(); // XMLHttpRequest 对象
            xhr.open("post", url, true); //post方式，url为服务器请求地址，true 该参数规定请求是否异步处理。
            xhr.onload = function() {
                if (xhr.status === 200) {
                    var obj = JSON.parse(xhr.responseText);
                    if (obj.retCode === '000000') {
                        $("#add_fileUploadBtn,#submit").attr("disabled",false);
                        $(".loading_box").hide();
                        Ewin.alert({
                            message: "上传成功!"
                        });
                        var data = obj.rows;
                    }else if (obj.retCode === '999999') {
                        $("#add_fileUploadBtn,#submit").attr("disabled",false);
                        $(".loading_box").hide();
                        $("#uploadFolderMainList").html("");
                        Ewin.alert({
                            message: obj.retMsg
                        });
                        return false;
                    } else {
                        Ewin.alert({
                            message: obj.retMsg
                        });
                        return false;
                    }
                } else {
                    Ewin.alert({
                        message: obj.retMsg
                    });
                    return false;
                }
            };
            xhr.send(form_Data); //开始上传，发送form数据
        }, false);
    }

    function fileUploadClick() {
        var checked = $('.uploadFileBox_left_main input[type=radio]:checked');
        if (checked.length <= 0) {
            Ewin.alert({
                message: '请先选择上传的服务器文件夹!'
            });
            return false;
        } else {
            var filePathInput = $(".uploadFileBox_left_main").find("input:checked").attr("filePath");
            $("#folderUrl").val(filePathInput);
            $("#file-folder").trigger("click");
        }
    }

    $(".uploadFileBox_left_main").on("click", "label", function() {
        var radioStr = $(this).find("input[type='radio']").attr("filePath");
        var fileNameInput = $(this).find("input[type='radio']").attr("fileName");
        $("#folderUrl").val(radioStr).attr('fileName',fileNameInput);
    });


    function _doSubmit() {

        var folderUrl = $("#folderUrl").val();
        var index=folderUrl.lastIndexOf("folder");
        var reg = new RegExp("\\\\","g");//g,表示全部替换。
        var folder_Url=folderUrl.substring(index,folderUrl.length).replace(reg,"/");
        var accessPrefix =  host_url+"/" + folder_Url+"/";
        if (folderUrl == "") {
            Ewin.alert({
                message: "文件上传地址不能为空!"
            });
            return false;
        }
        if ($("#uploadFolderMainList span").length <= 0) {
            Ewin.alert({
                message: "请选择您要上传的文件"
            });
            return false;
        } else {
            $(".loading_box p").html("数据提交中，请稍后......");
            $("#add_fileUploadBtn,#submit").attr("disabled",true);
            $(".loading_box").show();

            var params = {
                _sys_login_token:login_token(),
                lists:[]
            }

            var arr = $('.uploadFolderMainList span');
            $.each(arr,function (k,v) {
                params.lists.push({
                    folderUrl:$(v).attr('fileUrl'),
                    folderName:$(v).text(),
                    accessPrefix:accessPrefix
                })
            })

            params.lists = JSON.stringify(params.lists);

            sendAjax( 'POST', host_url+"/file/addFile", params, function(res){
                $("#add_fileUploadBtn,#submit").attr("disabled",false);
                $(".loading_box").hide();
                Ewin.alert({ message: '恭喜你，操作成功！' }).on(function(e){
                    if(e){
                        $('#add_form').parents('.modal').modal('hide');
                        $(".table").bootstrapTable('refresh');
                        $('#submit').attr('disabled',false);
                    }
                });
            });

        }
    }
</script>