<link rel="stylesheet" href="../../../css/lib/daterangepicker-bs3.css" />
<link rel="stylesheet" href="../../../css/lib/bootstrap-table.min.css" />
<div class="content_center">
	<div class="content_center_content">
		<!--查询条件-->
		<div class="content_center_condition">
			<form id="query_pay_Form" name="query_pay_Form" role="form" class="form-inline">
				<div class="form-group">
					<label class="control-label">转出卡号：</label>
					<input name="payAcctNo" class="form-control" type="text" placeholder="转出卡号" autocomplete="off" />
				</div>
				<div class="form-group">
					<label class="control-label">转出户名：</label>
					<input name="payAcctName" class="form-control" type="text" placeholder="转出户名" autocomplete="off" />
				</div>
				<div class="form-group">
					<label class="control-label">转出别名：</label>
					<input name="payAliasName" class="form-control" type="text" placeholder="转出别名" autocomplete="off" />
				</div>
				<div class="form-group">
					<label class="control-label">平台流水号：</label>
					<input name="orderNo" class="form-control" type="text" placeholder="平台流水号" autocomplete="off" />
				</div>
				<div class="form-group">
					<label class="control-label">订单状态：</label>
					<select name="status" class="form-control" id="transactionCorePayTradeCollect_status"></select>
				</div>
				<div class="form-group">
					<label class="control-label">转入卡号：</label>
					<input type="text" name="recAcctNo" class="form-control" type="text" placeholder="转入卡号"
						autocomplete="off" />
				</div>
				<div class="form-group">
					<label class="control-label">转入户名：</label>
					<input name="recAcctName" class="form-control" type="text" placeholder="转入户名" autocomplete="off" />
				</div>
				<div class="form-group">
					<label class="control-label">转入别名：</label>
					<input name="recAliasName" class="form-control" type="text" placeholder="转入别名" autocomplete="off" />
				</div>
				<div class="form-group">
					<label class="control-label">申请操作员：</label>
					<input name="operatorName" class="form-control" type="text" placeholder="申请操作员" autocomplete="off" />
				</div>
				<div class="form-group">
					<label class="control-label">创建时间：</label>
					<input type="text" name="payAcceptTime" id="payquery_payTime" class="form-control dateranges"
						placeholder="创建时间" autocomplete="off" readonly="readonly" />
				</div>
				<div class="form-group pull-right">
					<button id="query_pay_button" class="btn btn-primary refreshBtn" type="button">
						<i class="fa fa-search"></i>查询
					</button>
					<button type="button" class="btn btn-default" onclick="query_pay_resetButton()">
						<i class="fa fa-refresh"></i> 重置
					</button>
				</div>
				<div class="clearfix"></div>
			</form>
		</div>
		<div class="content_center_table">
			<button type="button" class="btn btn-primary" onclick="collect_download()" style="margin-bottom: 6px;">
				导出Excel
			</button>
			<p class="marginBottom">
				总笔数：<span class="payqueryTotalCount"></span>笔 总金额：<span class="payqueryTotalAmt"></span>元 成功金额：<span
					class="payquerySuccessAmt"></span> 元
				成功总笔数：<span class="payquerySuccessCount"></span>笔
			</p>
			<table cellpadding="0" cellspacing="0" border="0" id="pay_Table" class="table table-bordered table-hover">
			</table>
		</div>
	</div>
</div>
<style type="text/css">
	#pay_Table.table {
		width: 2500px;
	}
</style>
<script>
	var firstDay = sys_formatDate(new Date().setDate(1)) + ' 00:00:00';
	var lastDay = getCurrentMonthLast() + ' 23:59:59';
	$(function () {
		listOptionInit(
			$("#transactionCorePayTradeCollect_status"),
			COLLECT_STATUS
		);
		$("#transactionCorePayTradeCollect_status").comboSelect();
		// 初始化双日历日期控件
		$('#payquery_payTime').val(firstDay + ' - ' + lastDay);
		$('#payquery_payTime').daterangepicker({
			timePicker: true,
			timePickerIncrement: 1,
			format: 'YYYY-MM-DD HH:mm:ss',
			startDate: firstDay,
			endDate: lastDay,
			opens: 'center',
		
		}, function (start, end, label) {
		
		});
		payquery_Table();
		payqueryTotalInfo();
	}); // 总笔数等信息
	function payqueryTotalInfo() {
		var paramForm = $("#query_pay_Form").serializeArray();
		var params = {};
		$.each(paramForm, function (i, param) {
			params[param.name] = $.trim(param.value);
		});
		if (params.payAcceptTime) {
			params.startTime = params.payAcceptTime.substring(0, 19);
			params.endTime = params.payAcceptTime.substring(21, 41);
		}
		delete params.payAcceptTime;
		sendAjax(
			"POST",
			host_url + "cloud-web/corePayMergeFlow/realTimeStatis",
			params,
			function (res) {
				var data = res.rows;
				if (data == "") {
					$(".payqueryTotalCount").html("0");
					$(".payquerySuccessCount").html("0");
					$(".payquerySuccessAmt").html(formatterMoney("0"));
					$(".payqueryTotalAmt").html(formatterMoney("0"));
				} else {
					$(".payqueryTotalCount").html(data.totalCount);
					if (data.totalAmt) {
						$(".payqueryTotalAmt").html(
							formatterMoney(data.totalAmt)
						);
					} else {
						$(".payqueryTotalAmt").html(formatterMoney("0"));
					}
					if (data.successAmt) {
						$(".payquerySuccessAmt").html(
							formatterMoney(data.successAmt)
						);
					} else {
						$(".payquerySuccessAmt").html(formatterMoney("0"));
					}
					$(".payquerySuccessCount").html(data.successCount);
				}
			}
		);
	}
	// 重置
	function query_pay_resetButton(){
		$("#query_pay_Form")[0].reset();
		$('#payquery_payTime').val(firstDay + ' - ' + lastDay);
	}
	//流水查询搜索
	$("#query_pay_button").click(function () {
		payInputPay();
	});
	// 判断是否跨月
	function payInputPay() {
		var paramForm = $("#query_pay_Form").serializeArray();
		var params = {};
		$.each(paramForm, function (i, param) {
			params[param.name] = $.trim(param.value);
		});
		var payAcceptTime = $('#payquery_payTime').val();
		if (payAcceptTime != '') {
			payAcceptTimestart = payAcceptTime.split(' - ')[0];
			payAcceptTimeEnd = payAcceptTime.split(' - ')[1];
		
			var start = parserDate(payAcceptTimestart),
				end = parserDate(payAcceptTimeEnd);
			if(start.getFullYear() != end.getFullYear()){
				Ewin.alert({
					message: "暂不支持跨年查询"
				});
				return;
			}else if (start.getMonth()+1 != end.getMonth()+1) {
				Ewin.alert({
					message: "暂不支持跨月查询"
				});
				return;
			}
		}
		$("#pay_Table").bootstrapTable("refresh");
		payqueryTotalInfo();
	}

	/*表格加载*/
	function payquery_Table() {
		$("#pay_Table").bootstrapTable({
			url: host_url + "/cloud-web/corePayMergeFlow/pageList",
			method: "GET",
			dataType: "json",
			contentType: "application/x-www-form-urlencoded;charset=UTF-8",
			pagination: true, //在表格底部显示分页工具栏
			pageNumber: 1,
			pageList: [20, 50, 100],
			clickToSelect: true,
			sidePagination: "server", //表格分页的位置
			cache: false, //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
			locale: "zh-CN", //中文支持
			queryParamsType: "limit",
			queryParams: function (params) {
				params.pageSize = params.limit; //页面大小
				params.page = params.offset / params.limit + 1; //页码
				params._sys_login_token = _get_sys_login_token();
				var paramForm = $("#query_pay_Form").serializeArray();
				$.each(paramForm, function (i, param) {
					params[param.name] = $.trim(param.value);
				});

				if (params.payAcceptTime) {
					params.startTime = params.payAcceptTime.substr(0, 19);
					params.endTime = params.payAcceptTime.substr(22);
				}
				delete params.payAcceptTime;
				return params;
			}, //参数
			columns: [
				{
					title: "序号",
					// checkbox: true,
					width: 30,
					align: "center",
					valign: "middle",
					formatter: function (value, row, index) {
						var options = $("#pay_Table").bootstrapTable(
							"getOptions"
						);
						return (
							(options.pageNumber - 1) * options.pageSize +
							index +
							1
						);
					}
				},
				{
					field: "orderNo",
					title: "平台流水号",
					width: 150,
					align: "center",
					valign: "middle"
				},
				{
					field: "payBankName",
					title: "转出银行",
					width: 100,
					align: "center",
					valign: "middle"
				},
				{
					field: "payAcctNo",
					title: "转出卡号",
					width: 160,
					align: "center",
					valign: "middle"
				},
				{
					field: "payAcctName",
					title: "转出户名",
					width: 80,
					align: "center",
					valign: "middle"
				},
				{
					field: "payAliasName",
					title: "转出账户别名",
					width: 80,
					align: "center",
					valign: "middle"
				},
				{
					field: "recBankName",
					title: "转入银行",
					width: 100,
					align: "center",
					valign: "middle"
				},
				{
					field: "recAcctNo",
					title: "转入卡号",
					width: 160,
					align: "center",
					valign: "middle"
				},
				{
					field: "recAcctName",
					title: "转入户名",
					width: 100,
					align: "center",
					valign: "middle"
				},
				{
					field: "recAliasName",
					title: "转入账户别名",
					width: 100,
					align: "center",
					valign: "middle"
				},
				{
					field: "payAmt",
					title: "归集金额(元)",
					width: 100,
					align: "right",
					valign: "middle",
					formatter: function (value, row, index) {
						return formatterMoney(value, 2);
					}
				},
				{
					field: "status",
					title: "订单状态",
					width: 100,
					align: "center",
					valign: "middle",
					formatter: function (value, row, index) {
						return visualParams(COLLECT_STATUS, value);
					}
				},
				{
					field: "createTime",
					title: "创建时间",
					width: 150,
					align: "center",
					valign: "middle",
					formatter: function (value) {
						return formatterDateTime(value);
					}
				},
				{
					field: "operatorName",
					title: "申请操作员",
					width: 100,
					align: "center",
					valign: "middle"
				},
				{
					field: "handlerTime",
					title: "办理时间",
					width: 150,
					align: "center",
					valign: "middle",
					formatter: function (value) {
						return formatterDateTime(value);
					}
				},
				{
					field: "recOperatorName",
					title: "抢单操作员",
					width: 100,
					align: "center",
					valign: "middle"
				},
				{
					field: "returnMsg",
					title: "返回描述",
					width: 100,
					align: "center",
					valign: "middle"
				},
				{
					field: "payTime",
					title: "完成时间",
					width: 150,
					align: "center",
					valign: "middle",
					formatter: function (value) {
						return formatterDateTime(value);
					}
				}
			],
			onClickRow: function (row, $element) {
				$($element)
					.addClass("table_info")
					.siblings()
					.removeClass("table_info");
			}
		});
	}

	// 导出Excel
	function collect_download() {
		var params = {};
		params._sys_login_token = _get_sys_login_token();
		var paramForm = $("#query_pay_Form").serializeArray();
		$.each(paramForm, function (i, param) {
			params[param.name] = $.trim(param.value);
		});
		if (params.payAcceptTime) {
			params.startTime = params.payAcceptTime.substring(0, 19);
			params.endTime = params.payAcceptTime.substring(21, 41);
			
			var startMonth = parserDate(params.startTime),
				endMonth = parserDate(params.endTime);
			if(startMonth.getFullYear() != endMonth.getFullYear()){
				Ewin.alert({
					message: "暂不支持跨年下载"
				});
				return;
			}else if (startMonth.getMonth()+1 != endMonth.getMonth()+1) {
				Ewin.alert({
					message: "暂不支持跨月下载"
				});
				return;
			}
		}
		delete params.payAcceptTime;
		var start = parserDate(params.startTime).getTime(),
			end = parserDate(params.endTime).getTime();
		if (start > end) {
			Ewin.alert({
				message: "创建时间的开始时间不能大于结束时间"
			});
			return;
		} else {
			// 259200000 = 1000*60*60*24*3
			if ((end - start) > 259200000) {
				Ewin.alert({
					message: "创建时间的时间间隔不能超过3天"
				});
				return;
			}
		}
		var url = "";
		$.each(params, function (i, item) {
			url += "&" + i + "=" + item;
		});
		if (params.payAcceptTime == "") {
			Ewin.alert({ message: "未选择时间范围筛选，仅下载当天数据" }).on(
				function (e) {
					if (e) {
						sendAjax('POST', host_url + "/cloud-web/corePayTradeFlow/checkDown", {}, function (res) {
							window.location.href =
								host_url +
								"/cloud-web/corePayMergeFlow/down?" +
								url;
						});
					} else {
						return;
					}
				}
			);
		} else {
			sendAjax('POST', host_url + "/cloud-web/corePayTradeFlow/checkDown", {}, function (res) {
				window.location.href =
					host_url + "/cloud-web/corePayMergeFlow/down?" + url;
			});
		}
	}
</script>