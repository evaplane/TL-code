<link rel="stylesheet" href="../../../css/lib/daterangepicker-bs3.css">
<link rel="stylesheet" href="../../../css/lib/bootstrap-table.min.css" />
<div class="content_center">
	<div class="content_center_content">
		<!--查询条件-->
		<div class="content_center_condition" style="position: relative;">
			<form id="query_proceedsquery_Form" name="query_proceedsquery_Form" role="form" class="form-inline">
				<div class="form-group">
					<label class="control-label">平台号：</label>
					<input name="customerNo" class="form-control" type="text" placeholder="平台号" autocomplete="off">
				</div>
				<div class="form-group">
					<label class="control-label">平台名称：</label>
					<input name="customerName" class="form-control" type="text" placeholder="平台名称" autocomplete="off">
				</div>
				<div class="form-group">
					<label class="control-label">用户名：</label>
					<input name="userAcct" class="form-control" type="text" placeholder="用户名" autocomplete="off">
				</div>
				<!-- <a href="javascript:void(0)" onclick="formItemDown(this)" style="position: absolute; left: 47%; bottom: -5px;">
					<img src="../../../img/arrow-down.png" width="20" />
				</a>
				<span class="formItem"> -->
					<div class="form-group">
						<label class="control-label">真实姓名：</label>
						<input name="userName" class="form-control" type="text" placeholder="真实姓名" autocomplete="off">
					</div>
					<div class="form-group">
						<label class="control-label">账户别名：</label>
						<input name="userAliasName" class="form-control" type="text" placeholder="账户别名" autocomplete="off">
					</div>
					<div class="form-group">
						<label class="control-label">入金卡号：</label>
						<input name="recAcctNo" class="form-control" type="text" placeholder="入金卡号" autocomplete="off">
					</div>
					<div class="form-group">
						<label class="control-label">入金户名：</label>
						<input name="recAcctName" class="form-control" type="text" placeholder="入金户名" autocomplete="off">
					</div>
					<div class="form-group">
						<label class="control-label">客户单号：</label>
						<input name="cusOrderNo" class="form-control" type="text" placeholder="客户单号" autocomplete="off">
					</div>
					<div class="form-group">
						<label class="control-label">平台流水号：</label>
						<input type="text" name="orderNo" class="form-control" type="text" placeholder="平台流水号"
							autocomplete="off">
					</div>
					<div class="form-group">
						<label class="control-label">订单状态：</label>
						<select name="status" class="form-control" id="TradeStatus_select"></select>
					</div>
					<div class="form-group">
						<label class="control-label">领单操作员：</label>
						<input name="operatorName" class="form-control" type="text" placeholder="领单操作员" autocomplete="off">
					</div>
					<div class="form-group">
						<label class="control-label">是否首次入款：</label>
						<select name="isFirst" class="form-control" id="isFirst_select"></select>
					</div>
					<div class="form-group">
						<label class="control-label">财务处理时长：</label>
						<input name="startTakeTime" class="form-control importWidth" type="text" placeholder="起始范围"
							autocomplete="off">
						<input name="endTakeTime" class="form-control importWidth" type="text" placeholder="结束范围"
							autocomplete="off">
					</div>
					<div class="form-group">
						<label class="control-label">金额范围：</label>
						<input name="startPayAmt" class="form-control importWidth" type="text" placeholder="起始范围"
							autocomplete="off">
						<input name="endPayAmt" class="form-control importWidth" type="text" placeholder="结束范围"
							autocomplete="off">
					</div>
					<div class="form-group">
						<label class="control-label">创建时间：</label>
						<input type="text" name="transCreateTime" id="procee_transCreateTime"
							class="form-control dateranges" placeholder="创建时间" autocomplete="off" readonly="readonly" />
					</div>
					<div class="form-group">
						<label class="control-label">完成时间：</label>
						<input type="text" name="transPayTime" id="transPayTime" class="form-control dateranges"
							placeholder="完成时间" autocomplete="off" readonly="readonly" />
					</div>
				<!-- </span> -->
				<div class="form-group pull-right">
					<button id="query_proceedsquery_button" type="button" class="btn btn-primary refreshBtn"><i
							class="fa fa-search"></i>查询</button>
					<button type="button" class="btn btn-default" onclick="proceedsReset()"><i
							class="fa fa-refresh"></i> 重置</button>
				</div>
				<div class="clearfix"></div>
			</form>
		</div>
		<div class="content_center_table">
			<button type="button" class="btn btn-primary" onclick="pro_download()" style="margin-bottom: 6px;">
				导出excel</button>
			<p class="marginBottom">
				总笔数：<span class="prototalCount"></span>笔 总金额：<span class="prototalAmt"></span>元 成功金额：<span
					class="prosuccessAmt"></span>元 成功总笔数：<span class="prosuccessCount"></span>笔
			</p>
			<table cellpadding="0" cellspacing="0" border="0" id="proceeds_Table"
				class="table table-bordered table-hover"></table>
		</div>
	</div>
</div>
<style type="text/css">
	#proceeds_Table.table {
		width: 3800px;
	}
	/* .formItem{
		display: none;
	} */
</style>
<script>
	var tradeTypeList;
	var firstDay = sys_formatDate(new Date().setDate(1)) + ' 00:00:00';
	var lastDay = getCurrentMonthLast() + ' 23:59:59';
	$(function () {
		listOptionInit($('#TradeStatus_select'), PAY_STATUS);
		$('#TradeStatus_select').comboSelect();
		listOptionInit($('#isFirst_select'), IS_STATUS);
		$('#isFirst_select').comboSelect();

		findConstantValue('Core', 'pay_type');
		setTimeout(function () {
			tradeTypeList = lists;
			proceedsquery_Table();
		}, 500);

		initDate();
		prototalInfo();
	});
	// 展开/收起
	// function formItemDown(val){
	// 	if($(val).find('img').attr('src')=="../../../img/arrow-up.png"){
	// 		$(val).find('img').attr('src','../../../img/arrow-down.png');
	// 		$('.formItem').fadeOut();
	// 	}else{
	// 		$(val).find('img').attr('src','../../../img/arrow-up.png');
	// 		$('.formItem').fadeIn();
	// 	}
	// }

	// 重置
	function proceedsReset() {
		$("#query_proceedsquery_Form")[0].reset();
		$('#procee_transCreateTime').val(firstDay + ' - ' + lastDay);
	}
	// 搜索
	$("#query_proceedsquery_button").click(function () {
		inputPay();
	});
	// 金额校验
	var regexpAmt = /^-?\d+\.?\d{0,2}$/;
	var regexpTime = /^\+?[0-9][0-9]*$/;
	function inputPay() {
		var paramForm = $("#query_proceedsquery_Form").serializeArray();
		var params = {};
		$.each(paramForm, function (i, param) {
			params[param.name] = $.trim(param.value);
		});
		var payAcceptTime = $('#procee_transCreateTime').val();
		if (payAcceptTime != '') {
			payAcceptTimestart = payAcceptTime.split(' - ')[0];
			payAcceptTimeEnd = payAcceptTime.split(' - ')[1];
		
			var start = parserDate(payAcceptTimestart),
				end = parserDate(payAcceptTimeEnd);
			if(start.getFullYear() != end.getFullYear()){
				Ewin.alert({
					message: "暂不支持跨年查询"
				});
				return;
			}else if (start.getMonth() + 1 != end.getMonth() + 1) {
				Ewin.alert({
					message: "暂不支持跨月查询"
				});
				return;
			}
		}
		if (params.startPayAmt) {
			if (!regexpAmt.test(params.startPayAmt)) {
				Ewin.alert({
					message: '请输入正确的金额(小数点后最多两位)'
				});
				return false;
			}
		}

		if (params.endPayAmt) {
			if (!regexpAmt.test(params.endPayAmt)) {
				Ewin.alert({
					message: '请输入正确的金额(小数点后最多两位)'
				});
				return false;
			}
		}
		if (parseInt(params.startPayAmt) > parseInt(params.endPayAmt) || parseInt(params.startTakeTime) > parseInt(params.endTakeTime)) {
			Ewin.alert({
				message: '起始范围不能大于结束范围'
			});
			return false;
		}
		if (params.startTakeTime) {
			if (!regexpTime.test(params.startTakeTime)) {
				Ewin.alert({
					message: '请输入正确的时长'
				});
				return false;
			}
		}

		if (params.endTakeTime) {
			if (!regexpTime.test(params.endTakeTime)) {
				Ewin.alert({
					message: '请输入正确的时长'
				});
				return false;
			}
		}
		$("#proceeds_Table").bootstrapTable('refresh');
		prototalInfo();
	}
	// 总笔数等信息
	function prototalInfo() {
		var paramForm = $("#query_proceedsquery_Form").serializeArray();
		var params = {};
		$.each(paramForm, function (i, param) {
			params[param.name] = $.trim(param.value);
		});
		if (params.transCreateTime) {
			params.startTime = params.transCreateTime.substring(0, 19);
			params.endTime = params.transCreateTime.substring(21, 41);
		}
		if (params.transPayTime) {
			params.startPayTime = params.transPayTime.substring(0, 19);
			params.endPayTime = params.transPayTime.substring(21, 41);
		}
		if (params.startPayAmt) {
			params.startPayAmt = (params.startPayAmt * 100).toFixed(0);
		}
		if (params.endPayAmt) {
			params.endPayAmt = (params.endPayAmt * 100).toFixed(0);
		}
		delete params.transCreateTime;
		delete params.transPayTime;
		sendAjax('POST', host_url + "/cloud-web/corePayTradeFlow/realTimeStatis", params, function (res) {
			var data = res.rows;
			if (data == "") {
				$(".prototalCount").html('0');
				$(".prosuccessCount").html('0');
				$(".prosuccessAmt").html(formatterMoney('0'));
				$(".prototalAmt").html(formatterMoney('0'));
			} else {
				$(".prototalCount").html(data.totalCount);
				if (data.totalAmt) {
					$(".prototalAmt").html(formatterMoney(data.totalAmt));
				} else {
					$(".prototalAmt").html(formatterMoney('0'));
				}
				if (data.successAmt) {
					$(".prosuccessAmt").html(formatterMoney(data.successAmt));
				} else {
					$(".prosuccessAmt").html(formatterMoney('0'));
				}
				$(".prosuccessCount").html(data.successCount);
			}
		});
	}

	// 时间插件
	function initDate() {
		// 初始化双日历日期控件
		$('#procee_transCreateTime').val(firstDay + ' - ' + lastDay);
		$('#procee_transCreateTime').daterangepicker({
			timePicker: true,
			timePickerIncrement: 1,
			format: 'YYYY-MM-DD HH:mm:ss',
			startDate: firstDay,
			endDate: lastDay,
			opens: 'center',

		}, function (start, end, label) {

		});
		$('#transPayTime').daterangepicker({
			timePicker: true,
			timePickerIncrement: 1,
			format: 'YYYY-MM-DD HH:mm:ss',
			// startDate: firstDay,
			// endDate: lastDay,
			opens: 'center',

		}, function (start, end, label) {

		});
	}


	/*表格加载*/
	function proceedsquery_Table() {
		$('#proceeds_Table').bootstrapTable({
			url: host_url + '/cloud-web/corePayTradeFlow/pageList',
			method: 'GET',
			dataType: "json",
			contentType: "application/x-www-form-urlencoded;charset=UTF-8",
			pagination: true, //在表格底部显示分页工具栏  
			pageNumber: 1,
			pageList: [20, 50, 100],
			clickToSelect: true,
			sidePagination: "server", //表格分页的位置
			cache: false, //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
			locale: 'zh-CN', //中文支持
			queryParamsType: 'limit',
			queryParams: function (params) {
				params.pageSize = params.limit; //页面大小
				params.page = (params.offset / params.limit) + 1; //页码
				params._sys_login_token = _get_sys_login_token();

				var paramForm = $("#query_proceedsquery_Form").serializeArray();
				$.each(paramForm, function (i, param) {
					params[param.name] = $.trim(param.value);
				});
				if (params.startPayAmt) {
					params.startPayAmt = (params.startPayAmt * 100).toFixed(0);
				}
				if (params.endPayAmt) {
					params.endPayAmt = (params.endPayAmt * 100).toFixed(0);
				}
				if (params.transCreateTime) {
					params.startTime = params.transCreateTime.substring(0, 19);
					params.endTime = params.transCreateTime.substring(21, 41);
				}
				if (params.transPayTime) {
					params.startPayTime = params.transPayTime.substring(0, 19);
					params.endPayTime = params.transPayTime.substring(21, 41);
				}
				delete params.transCreateTime;
				delete params.transPayTime;
				return params;
			}, //参数  
			columns: [{
				title: '序号',
				// checkbox: true,
				width: 30,
				align: "center",
				valign: "middle",
				formatter: function (value, row, index) {
					var options = $('#proceeds_Table').bootstrapTable("getOptions");
					return (options.pageNumber - 1) * (options.pageSize) + index + 1;
				}
			},
			{ field: 'customerNo', title: '平台号', width: 120, align: "center", valign: "middle" },
			{ field: 'customerName', title: '平台名称', width: 120, align: "center", valign: "middle" },
			{ field: 'userAcct', title: '用户名', width: 100, align: "center", valign: "middle" },
			{ field: 'userName', title: '真实姓名', width: 120, align: "center", valign: "middle" },
			{ field: 'userLevel', title: '用户星级', width: 50, align: "center", valign: "middle" },
			{
				field: 'orderAmt', title: '订单金额(元)', width: 100, align: "right", valign: "middle",
				formatter: function (value, row, index) {
					return formatterMoney(value, 2)
				}
			},
			{
				field: 'payAmt', title: '存款金额(元)', width: 100, align: "right", valign: "middle",
				formatter: function (value, row, index) {
					return formatterMoney(value, 2)
				}
			},
			{ field: 'payAcctName', title: '存款人', width: 100, align: "center", valign: "middle" },
			{
				field: 'status',
				title: '订单状态',
				width: 80,
				align: "center",
				valign: "middle",
				formatter: function (value, row, index) {
					return visualParams(PAY_STATUS, value);
				}
			},
			{
				field: 'payType', title: '存款方式', width: 120, align: "center", valign: "middle",
				formatter: function (value, row, index) {
					return sys_getTitle_Id(value, tradeTypeList);
				},
			},
			{ field: 'cusOrderNo', title: '客户单号', width: 200, align: "center", valign: "middle" },
			{ field: 'orderNo', title: '平台流水号', width: 200, align: "center", valign: "middle" },
			{ field: 'recAcctNo', title: '入金卡号', width: 200, align: "center", valign: "middle" },
			{ field: 'userAliasName', title: '账户别名', width: 120, align: "center", valign: "middle" },
			{ field: 'recAcctName', title: '入金户名', width: 120, align: "center", valign: "middle" },
			{ field: 'recBankName', title: '入金银行', width: 180, align: "center", valign: "middle" },
			{ field: 'recRemark', title: '银行附言', width: 100, align: "center", valign: "middle" },
			{ field: 'operatorName', title: '领单操作员', width: 130, align: "center", valign: "middle" },
			{ field: 'operatorCode', title: '领单操作员账号', width: 120, align: "center", valign: "middle" },
			{
				field: 'operatorTime', title: '财务办理时间', width: 160, align: "center", valign: "middle",
				formatter: function (value, row, index) {
					if (value == '') {
						return '-';
					} else {
						return getDateStr(value);
					}
				}
			},
			{ field: 'operatorRemark', title: '财务备注', width: 250, align: "center", valign: "middle" },
			{ field: 'authName', title: '复核操作员', width: 150, align: "center", valign: "middle" },
			{ field: 'authCode', title: '复核操作员账号', width: 120, align: "center", valign: "middle" },
			{
				field: 'authTime', title: '财务复核时间', width: 160, align: "center", valign: "middle",
				formatter: function (value, row, index) {
					if (value == null) {
						return '-';
					} else {
						return getDateStr(value);
					}

				}
			},
			{ field: 'authRemark', title: '财务复核备注', width: 120, align: "center", valign: "middle" },
			{
				field: 'takeTime', title: '财务处理时长（秒）', width: 100, align: "center", valign: "middle",
				formatter: function (value, row, index) {
					if (row.status == 20) {
						return '-';
					} else {
						return value;
					}
				}
			},
			{
				field: 'isFirst', title: '是否首次入款', width: 60, align: "center", valign: "middle",
				formatter: function (value, row, index) {
					return visualParams(IS_STATUS, value);
				}
			},
			{
				field: 'payTime', title: '完成时间', width: 160, align: "center", valign: "middle",
				formatter: function (value, row, index) {
					return getDateStr(value);
				}
			},
			{ field: 'returnMsg', title: '返回描述', width: 160, align: "center", valign: "middle" },
			{
				field: 'createTime', title: '创建时间', width: 170, align: "center", valign: "middle",
				formatter: function (value, row, index) {
					return getDateStr(value);
				}
			},
			{
				field: 'updateTime', title: '更新时间', width: 170, align: "center", valign: "middle",
				formatter: function (value, row, index) {
					return getDateStr(value);
				}
			}

			],
			onClickRow: function (row, $element) {
				$($element).addClass('table_info').siblings().removeClass('table_info');
			},
			onLoadSuccess: function (res) {
				//加载成功时执行
			},
		});
	}
	// 导出
	function pro_download() {
		var params = {};
		params._sys_login_token = _get_sys_login_token();
		var paramForm = $("#query_proceedsquery_Form").serializeArray();
		$.each(paramForm, function (i, param) {
			params[param.name] = $.trim(param.value);
		});
		if (params.transCreateTime) {
			params.startTime = params.transCreateTime.substring(0, 19);
			params.endTime = params.transCreateTime.substring(21, 41);
			
			var startMonth = parserDate(params.startTime),
				endMonth = parserDate(params.endTime);
			if(startMonth.getFullYear() != endMonth.getFullYear()){
				Ewin.alert({
					message: "暂不支持跨年下载"
				});
				return;
			}else if (startMonth.getMonth()+1 != endMonth.getMonth()+1) {
				Ewin.alert({
					message: "暂不支持跨月下载"
				});
				return;
			}
		}
		if (params.transPayTime) {
			params.startPayTime = params.transPayTime.substring(0, 19);
			params.endPayTime = params.transPayTime.substring(21, 41);
		}
		if (params.startPayAmt) {
			params.startPayAmt = (params.startPayAmt * 100).toFixed(0);
		}
		if (params.endPayAmt) {
			params.endPayAmt = (params.endPayAmt * 100).toFixed(0);
		}
		delete params.transCreateTime;
		delete params.transPayTime;

		var start = parserDate(params.startTime).getTime(),
			end = parserDate(params.endTime).getTime();
		if (start > end) {
			Ewin.alert({
				message: "创建时间的开始时间不能大于结束时间"
			});
			return;
		} else {
			// 259200000 = 1000*60*60*24*3
			if ((end - start) > 259200000) {
				Ewin.alert({
					message: "创建时间的时间间隔不能超过3天"
				});
				return;
			}
		}
		var url = '';
		$.each(params, function (i, item) {
			url += '&' + i + '=' + item;
		});
		if (params.transCreateTime == "" && params.transPayTime == "") {
			Ewin.alert({ message: '未选择时间范围筛选，仅下载当天数据' }).on(function (e) {
				if (e) {
					sendAjax('POST', host_url + "/cloud-web/corePayTradeFlow/checkDown", {}, function (res) {
						window.location.href = host_url + "/cloud-web/corePayTradeFlow/down?" + url;
					});
				} else {
					return;
				}
			});
		} else {
			sendAjax('POST', host_url + "/cloud-web/corePayTradeFlow/checkDown", {}, function (res) {
				window.location.href = host_url + "/cloud-web/corePayTradeFlow/down?" + url;
			});
		}
	}
</script>