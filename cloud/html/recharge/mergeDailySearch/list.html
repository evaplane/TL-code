<div class="content_center">
	<div class="content_center_content">
		<p class="pull-right">
			<!-- <button id="query_button" type="button" class="btn btn-primary" onclick="shiftsTime()">
				<i class="fa fa-edit"></i> 配置班次
			</button> -->
		</p>
		<div class="clearfix"></div>
		<div id="mergeDailySearch"></div>
	</div>
</div>
<style>
	.popover-content {
		width: 250px;
	}

	.popover {
		word-break: break-word;
	}

	input {
		font-weight: normal;
	}
</style>
<script type="text/javascript">
	$(function () {
		getMergeDailySearchTable();
	});

	function getMergeDailySearchTable() {
		sendAjax(
			"GET",
			host_url + "/cloud-web/cardRoutePoolInfo/viewLoad",
			{ cardUseType: 30 },
			function (res) {
				var data = res.rows.list;
				var str = "";
				$.each(data, function (k, v) {
					str += '<div class="content_center_table">';
					str +=
						'<div class="content_center_title">' +
						v.routeName +
						" | " +
						v.timeLimit;

					str +=
						'<form id="mergeDailySearchForm_' +
						v.id +
						'" name="accountFlowForm" role="form" class="form-inline">' +
						'<div class="form-group">' +
						'<label class="control-label">银行账号：</label>' +
						'<select id="mergeDailySearch_acctNo' +
						v.id +
						'" name="acctNo"></select>' +
						"</div>" +
						// '<div class="form-group">'+
						// 	'<label class="control-label">账号用途：</label>'+
						// 	'<select id="mergeDailySearch_cardUseType'+v.id+'" name="cardUseType"></select>'+
						// '</div>'+
						'<div class="form-group">' +
						'<label class="control-label">财务人员：</label>' +
						'<select id="mergeDailySearch_operatorName' +
						v.id +
						'" name="operatorCode"></select>' +
						"</div>" +
						// '<div class="form-group">'+
						// 	'<label class="control-label">会员配置：</label>'+
						// 	'<select id="mergeDailySearch_cusList'+v.id+'" name="cusCode"></select>'+
						// '</div>'+
						'<div class="form-group">' +
						'<label class="control-label">开放量级：</label>' +
						'<select id="mergeDailySearch_acctLevel' + v.id + '" name="acctLevel"></select>' +
						'</div>' +
						// '<div class="form-group">' +
						// '<label class="control-label">出金限额：</label>' +
						// '<select id="mergeDailySearch_amtCode' +
						// v.id +
						// '" name="amtCode"></select>' +
						// "</div>" +
						'<div class="form-group">' +
						'<label class="control-label">状态：</label>' +
						'<select id="mergeDailySearch_status' +
						v.id +
						'" name="status"></select>' +
						"</div>" +
						'<div class="form-group pull-right">' +
						'<button type="button" class="btn btn-primary refreshBtn" onclick="mergeDailySearchSearch(' +
						v.id +
						')">查询</button>' +
						'<button type="reset" class="btn btn-default marginLeft">重置</button>' +
						"</div>" +
						'<div class="clearfix"></div>' +
						"</form>";

					str += "</div>";
					str +=
						'<table cellpadding="0" cellspacing="0" border="0" id="mergeDailySearch_' +
						v.id +
						'" class="table mergeDailySearch table-bordered table-hover"></table>';
					str += "</div>";
				});
				$("#mergeDailySearch").html(str);

				for (var i = 0; i < data.length; i++) {
					CusMember("mergeDailySearch_cusList" + data[i].id); //会员配置
					getOperatorName(
						"mergeDailySearch_operatorName" + data[i].id,
						data[i].routeCode
					); //财务人员
					getBankByRouteCode(
						"mergeDailySearch_acctNo" + data[i].id,
						data[i].routeCode
					); //银行账号
					getCardUseType("mergeDailySearch_cardUseType" + data[i].id); //账号用途
					getLevel('mergeDailySearch_acctLevel' + data[i].id); //开放量级
					listOption(
						$("#mergeDailySearch_status" + data[i].id),
						SYS_STATUS
					);
					listOptionInit(
						$("#mergeDailySearch_amtCode" + data[i].id),
						PAY_QUOTA
					);
					$("#mergeDailySearch_status" + data[i].id).comboSelect();
					$("#mergeDailySearch_amtCode" + data[i].id).comboSelect();
					initmergeDailySearchTable(
						"mergeDailySearch_" + data[i].id,
						data[i].merchList,
						data[i].routeCode,
						data[i].id
					);
				}
			}
		);
	}
	// 查询
	function mergeDailySearchSearch(obj) {
		var paramForm = $("#mergeDailySearchForm_" + obj).serializeArray();
		var params = {};
		$.each(paramForm, function (i, param) {
			params[param.name] = $.trim(param.value);
		});
		params.cardUseType = 30;
		var reg = /^\d+(\.\d+)?$/
		if (params.acctLevel) {
			if (!params.acctLevel.match(reg) && params.acctLevel != '') {
				Ewin.alert({
					message: '开放量级只能输入正数'
				});
				return
			}
		}
		sendAjax(
			"Post",
			host_url + "/cloud-web/cardRoutePoolInfo/viewLoad",
			params,
			function (res) {
				var data = res.rows.list;

				for (var i = 0; i < data.length; i++) {
					if (obj == data[i].id) {
						$("#mergeDailySearch_" + data[i].id).bootstrapTable(
							"refresh"
						);
						initmergeDailySearchTable(
							"mergeDailySearch_" + data[i].id,
							data[i].merchList,
							data[i].routeCode,
							data[i].id
						);
					}
				}
			}
		);
	}
	// 会员配置
	function CusMember(obj) {
		sendAjax(
			"POST",
			host_url + "/cloud-web/cusMemberInfo/getAllCusMember",
			{},
			function (data) {
				$("#" + obj).html("");
				var Member = '<option value="">全部</option>';
				$.each(data.rows, function (i, item) {
					Member +=
						'<option value="' +
						item.cusCode +
						'">' +
						item.cusCode +
						"(" +
						item.cusName +
						")</option>";
				});
				$("#" + obj).append(Member);
				$("#" + obj).comboSelect();
			}
		);
	}
	// 开放量级
	function getLevel(obj) {
		sendAjax(
			"POST",
			host_url + "/cloud-web/cardBankCardInfo/loadLevel",
			{},
			function (res) {
				$("#" + obj).html("");
				var Level = '<option value="">全部</option>';
				$.each(res.rows, function (i, item) {
					Level +=
						'<option value="' +
						item.keyValue +
						'" data-value="' +
						item.id +
						'">' +
						item.keyName +
						"</option>";
				});
				$("#" + obj).append(Level);
				$("#" + obj).comboSelect();
			}
		);
	}
	// 财务人员
	function getOperatorName(obj, code) {
		sendAjax(
			"POST",
			host_url + "/cloud-web/cardRoutePoolMerch/queryGroupOperatorCode",
			{ routeCode: code, cardUseType: 30 },
			function (res) {
				var lists = '<option value="">全部</option>';
				$.each(res.rows, function (i, item) {
					lists +=
						'<option value="' +
						item.operatorCode +
						'">' +
						item.operatorName +
						"</option>";
				});
				$("#" + obj).append(lists);
				$("#" + obj).comboSelect();
			}
		);
	}
	// 银行账号
	function getBankByRouteCode(obj, code) {
		sendAjax(
			"get",
			host_url + "/cloud-web/cardRoutePoolMerch/loadBankByRouteCode",
			{ routeCode: code, cardUseType: 30 },
			function (res) {
				var str = '<option value="">全部</option>';
				$.each(res.rows, function (i, item) {
					str +=
						'<option value="' +
						item.acctNo +
						'" aliasName="' +
						item.aliasName +
						'">' +
						item.aliasName +
						"| " +
						item.acctNo +
						"</option>";
				});
				$("#" + obj).append(str);
				$("#" + obj).comboSelect();
			}
		);
	}
	// 账号用途
	function getCardUseType(obj) {
		sendAjax(
			"POST",
			host_url + "/cloud-web/pubTypeGroup/findPubTypeGroupList",
			{ sysCode: "Card", groupName: "card_type" },
			function (data) {
				var cardUseType = '<option value="">全部</option>';
				$.each(data.rows, function (i, item) {
					cardUseType +=
						'<option value="' +
						item.keyValue +
						'">' +
						item.keyName +
						"</option>";
				});
				$("#" + obj).append(cardUseType);
				$("#" + obj).comboSelect();
			}
		);
	}
	//判断是否为手动修改产品状态按钮
	var flag_btn = true;
	/*表格加载*/
	function initmergeDailySearchTable(obj, arr, routeCode,objId) {
		$("#" + obj).bootstrapTable("destroy");
		$("#" + obj).bootstrapTable({
			data: arr,
			locale: "zh-CN", //中文支持
			clickToSelect: true,
			columns: [
				{
					title: "序号",
					width: 30,
					align: "center",
					valign: "middle",
					formatter: function (value, row, index) {
						return index + 1;
					}
				},
				{
					title: "操作",
					field: "operation",
					align: "center",
					valign: "middle",
					width: 60,
					formatter: function (value, row, index) {
						return (
							'<a class="fa fa-trash-o a_size"  onclick="mergeDailySearchDel(\'' +
							row.id +
							"')\"></a> "+
							'<a class="operation a_size" title="账户期初" onclick="mergeDailySearchSet(\'' + row.id+ '\',\'' + row.aliasName+"')\"><img width='18' src='../../../img/cz.svg'></a> "
						);
					}
				},
				{
					field: "aliasName",
					title: "账号别名",
					width: 100,
					align: "center",
					valign: "middle"
				},
				{
					field: "acctNo",
					title: "银行账号",
					width: 180,
					align: "center",
					valign: "middle"
				},
				{
					field: "cardUseType",
					title: "账号用途",
					width: 80,
					align: "center",
					valign: "middle",
					formatter: function (value, row, index) {
						return sys_getTitle_Id(value, DEBIT_CARD);
					}
				},
				{
					field: "operatorName",
					title: "财务人员",
					width: 100,
					align: "center",
					valign: "middle"
				},
				{
					field: "groupName",
					title: "财务组长",
					width: 100,
					align: "center",
					valign: "middle"
				},
				{
					field: "status",
					title: "状态",
					width: 80,
					align: "center",
					valign: "middle",
					formatter: function (value, row, index) {
						var mergeSwitch;
						if (value == 100) {
							mergeSwitch =
								'<div class="mergeSwitch ' +
								obj +
								'" data-on="success" data-off="warning"><input type="checkbox" value="' +
								row.id +
								'" checked /></div>';
						} else {
							mergeSwitch =
								'<div class="mergeSwitch ' +
								obj +
								'" data-on="success" data-off="warning"><input type="checkbox" value="' +
								row.id +
								'"/></div>';
						}
						return mergeSwitch;
					}
				},
				{
					field: 'acctLevel',
					title: '开放量级',
					width: 80,
					align: "cenetr",
					valign: "middle",
					formatter: function(value, row, index) {
						return xjReplace(value);
					}
				},
				{field:'dayStartAmt',title:'账户期初余额(元)',width:60,align:"center",valign:"middle",
					formatter:function(value,row,index){
						return formatterMoney(value);
					},
				},
				{
					field: "updateTime",
					title: "更新时间",
					width: 130,
					align: "center",
					valign: "middle",
					formatter: function (value, row, index) {
						return sys_formatDate(value, "yyyy-MM-dd HH:mm:ss");
					}
				}
			]
		});
		if (arr) {
			//加载成功时执行
			$("." + obj).bootstrapSwitch();
			//开关
			$("." + obj).on("switch-change", function (e, data) {
				if (!flag_btn) {
					flag_btn = true;
					return;
				} else {
					var el = $(data.el),
						value = data.value;
					var id = el[0].value;
					var values;
					if (value) {
						//on
						values = 100;
					} else {
						//off
						values = -100;
					}

					var params = { id: id, status: values };
					sendAjax(
						"POST",
						host_url + "/cloud-web/cardRoutePoolMerch/updateStatus",
						params,
						function (res) {
							alertTips({
								message: "恭喜你，操作成功！",
								id: "alert-success"
							});
							getMergeDailySearchTable();
						}
					);
				}
			});
			$(".cusList")
				.popover({
					container: "body",
					trigger: "hover"
				})
				.on("show.bs.popover", function () {
					$(this).addClass("popover_open");
				})
				.on("hide.bs.popover", function () {
					$(this).removeClass("popover_open");
				});
			$(".cusList").click(function () {
				if ($(this).hasClass("popover_open")) {
					$(this).popover("hide");
				} else {
					$(".popover_open").popover("hide");
					$(this).popover("show");
				}
				var e = arguments.callee.caller.arguments[0] || event;
				e.stopPropagation();
			});
		}
		$("#" + obj).bootstrapTable("hideLoading");
	}
	// 删除
	function mergeDailySearchDel(id) {
		Ewin.confirm({ message: "确定要删除该配置吗？" }).on(function (e) {
			if (e) {
				sendAjax(
					"post",
					host_url + "/cloud-web/cardRoutePoolMerch/delete",
					{ id: id },
					function (res) {
						Ewin.alert({ message: "恭喜你，操作成功！" }).on(
							function (e) {
								getMergeDailySearchTable();
							}
						);
					}
				);
			}
		});
	}
	// 账户期初
	function mergeDailySearchSet(id,aliasName){
		Ewin.dialog({
			url:
				"../../../html/recharge/mergeDailySearch/set.html?id=" +
				id+'&aliasName='+aliasName,
			title: "账户期初"
		});
	}
</script>