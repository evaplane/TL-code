<div class="content_center">
	<div class="content_center_content">
		<form class="form-horizontal" name="shifts_add_form" role="form" id="shifts_add_form">
			<div class="form-group">
				<label class="control-label col-xs-4 col-sm-3"><span class="red">*</span>账号用途</label>
				<div class="col-xs-8 col-sm-7">
					<input type="text" class="form-control" id="add_cardUseType" name="cardUseType" value="出款卡"
						readonly>
				</div>
			</div>
			<div class="form-group">
				<label class="control-label col-xs-4 col-sm-3"><span class="red">*</span>财务组长</label>
				<div class="col-xs-8 col-sm-7">
					<select class="form-control" id="add_groupCode" name="groupCode"></select>
				</div>
			</div>
			<div class="form-group finance">
				<label class="control-label col-xs-4 col-sm-3"><span class="red">*</span>财务人员</label>
				<div class="col-xs-8 col-sm-7">
					<select class="form-control" id="add_operatorCode" name="operatorCode"></select>
				</div>
			</div>
			<div class="form-group finance">
				<label class="control-label col-xs-4 col-sm-3"><span class="red">*</span>出金限额</label>
				<div class="col-xs-8 col-sm-7">
					<select class="form-control" id="add_amtCode" name="amtCode" onchange="changeAmtCode()"></select>
				</div>
			</div>
			<!-- <div class="form-group">
				<label class="control-label col-xs-4 col-sm-3"><span class="red">*</span>开放量级</label>
				<div class="col-xs-8 col-sm-7 add_acctLevel">
					<select class="multiselect multiselectLevel form-control" id="add_acctLevel" name="acctLevel" multiple="multiple"></select>
				</div>
			</div> -->
			<!-- <div class="form-group">
				<label class="control-label col-xs-4 col-sm-3">会员配置</label>
				<div class="col-xs-8 col-sm-7 add_Member">
					<select class="multiselect multiselectMember form-control" id="add_Member" name="cusCode" multiple="multiple"></select>
				</div>
			</div> -->
			<div class="form-group">
				<label class="control-label col-xs-4 col-sm-3"><span class="red">*</span>银行卡号</label>
				<div class="col-xs-8 col-sm-7">
					<select class="form-control" id="add_acctNo" name="acctNo"></select>
				</div>
				<i class="glyphicon glyphicon-plus btn_routeAmt_tradePeriod add_routeAmt_tradePeriod"
					onclick="addShiftAdd_fca()"></i>
			</div>
			<div class="bankNo"></div>
		</form>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
		<button type="button" class="btn btn-primary" onclick="_doSubmit()">保存</button>
	</div>
</div>
<link rel="stylesheet" href="../../../css/lib/bootstrap-multiselect.css" />
<style>
	.add_acctLevel .multiselect-container,
	.add_Member .multiselect-container {
		width: 100%;
	}
</style>
<script type="text/javascript" src="../../../js/lib/bootstrap-multiselect.js"></script>
<script type="text/javascript">
	var id = "", routeCode = "", shiftAdd_fca;
	$(function () {
		id = getQueryString("id");
		routeCode = getQueryString("routeCode");
		//getSelectLevelList();
		initData_shift();
	});
	function initData_shift() {
		//出金财务 60 出金财务组长 54
		shiftAdd_fca = 0;
		shift_validateForm();//验证初始化
		getSelectBankList(0);
		getSelectUserList(54);
		getMember();
		getSelectUserList(60);
		listOptionInit2('#add_amtCode', PAY_QUOTA)
		$('#add_amtCode').comboSelect();
		//账号用途
		// sendAjax( "POST", host_url+"/cloud-web/pubTypeGroup/findPubTypeGroupList", {sysCode:'Card','groupName':'card_type'}, function(data){
		// 	$('#add_cardUseType').html('');
		// 	let cardUseType ='<option value="">请选择</option>';
		// 	$.each(data.rows,function(i,item){
		// 		cardUseType += '<option value="'+item.keyValue+'">'+item.keyName+'</option>';
		// 	});
		// 	$('#add_cardUseType').append(cardUseType);
		// 	$("#add_cardUseType").comboSelect();
		// });
	}
	// 声明全局变量
	var acctNoList = [];
	// 添加固定金额
	function addShiftAdd_fca() {
		var acctNo = $('#add_acctNo option:selected').text();
		if (acctNo == "") {
			Ewin.alert({
				message: '请先选择银行卡'
			})
			return;
		}
		if (shiftAdd_fca < 10) {
			var rowId = "shiftAdd_fca" + shiftAdd_fca;
			var insertStr =
				'<div class="form-group"  id="' + rowId + '">' +
				'<label class="control-label col-xs-4 col-sm-3"></label>' +
				'<div class="col-xs-8 col-sm-7">' +
				'<input type="text" name="acctAdd" readonly="readonly" class="form-control" data-value="' + $('#add_acctNo').val() + '" value="' + acctNo + '">' +
				'</div>' +
				'<i class="glyphicon glyphicon-minus shift_del btn_routeAmt_tradePeriod cut_routeAmt_tradePeriod" onclick="shiftAdd_cfa(\'' +
				rowId + '\');"></i>' +
				'</div>' +
				'</div>';
			if ($('#add_acctNo').val() != "") {
				acctNoList.push($('#add_acctNo').val());
				acctNoList.sort();
				if (isRepeat(acctNoList)) {
					Ewin.alert({
						message: '卡号已添加'
					})
					var indexOne = acctNoList.indexOf($('#add_acctNo').val());
					if (indexOne > -1) {
						acctNoList.splice(indexOne, 1);
						shiftAdd_fca--;
					}
				} else {
					$(".bankNo").append(insertStr);
					shiftAdd_fca++;
					return;
				}
			}
		} else {
			Ewin.alert({
				message: '最多可添加10个银行卡号'
			})
		}
	}
	// 判断数据是否重复
	function isRepeat(arr) {
		var hash = {};
		for (var i in arr) {
			if (hash[arr[i]]) {
				return true;
			}
			// 不存在该元素，则赋值为true，可以赋任意值，相应的修改if判断条件即可
			hash[arr[i]] = true;
		}
		return false;
	}
	// 删除固定金额
	function shiftAdd_cfa(rowID) {
		shiftAdd_fca--;

		var index = acctNoList.indexOf($("#" + rowID + " input").attr('data-value'));
		if (index > -1) {
			acctNoList.splice(index, 1);
		}
		$("#" + rowID).remove();
	}
	// 获取 组长(54) 或 财务(60) 下拉框
	function getSelectUserList(role) {
		sendAjax('POST', host_url + "/cloud-web/ownSsoUser/selectUserListByRole", { 'role': role }, function (res) {
			var data = res.rows;
			var lists = "<option value=''>请选择</option>";
			$.each(data, function (i, item) {
				lists += '<option value="' + item.loginName + '" name="' + item.userName + '" >' + item.loginName + "(" + item.userName + ")" + '</option>';
			});
			if (role == 54) {
				$('#add_groupCode').html(lists);
				$('#add_groupCode').comboSelect();
			} else {
				$('#add_operatorCode').html(lists);
				$('#add_operatorCode').comboSelect();
			}
		});
	}
	// 出金限额
	function changeAmtCode() {
		var cardUseCode = $('#add_amtCode').val();
		if (cardUseCode) {
			getSelectBankList(cardUseCode);
		}
	}
	// 获取 银行卡号 下拉框
	function getSelectBankList(cardUseCode) {
		$('#add_acctNo').html('');
		sendAjax('POST', host_url + "/cloud-web/cardBankCardInfo/loadBank", { "id": id, "cardUseType": 20, "cardUseCode": cardUseCode }, function (res) {
			var data = res.rows;
			var lists = [];
			$.each(data, function (i, item) {
				lists.push({
					id: item.acctNo,
					text: item.aliasName + " / " + item.acctNo
				});
			});
			listOptionInit2($('#add_acctNo'), lists)
			$('#add_acctNo').comboSelect();
		});
	}

	var selectedValue = "";
	// 获取 开发量级 下拉框
	function getSelectLevelList() {
		new Promise(multiselectLevel).then(function () {
			$('.multiselectLevel').multiselect({
				buttonClass: 'btn',
				buttonWidth: '100%',
				buttonText: function (options) {
					if (options.length == 0) {
						return '请选择';
					} else {
						var selected = '';
						options.each(function () {
							selected += $(this).text() + ',';
						});
						return selected.substr(0, selected.length - 1);
					}
				},
				onChange: function (option, checked) {
					selectedValue = ""
					$('select#add_acctLevel option:selected').each(function (i, item) {
						selectedValue += $(item).val() + ',';
					});
				}
			});
		})

	}
	function multiselectLevel(suc) {
		sendAjax('POST', host_url + "/cloud-web/cardBankCardInfo/loadLevel", {}, function (res) {
			var data = res.rows;
			$.each(data, function (i, item) {
				var add_acctLevel = '<option value="' + item.keyValue + '" data-value="' + item.id + '">' + item.keyName + '</option>';
				$('#add_acctLevel').append(add_acctLevel);
			});
			if (suc) {
				suc();
			}
		});
	}
	var selectedMember = "";
	// 获取 会员配置 下拉框
	function getMember() {
		selectedMember = "";
		new Promise(multiselectgetMember).then(function () {
			$('.multiselectMember').multiselect({
				buttonClass: 'btn',
				buttonWidth: '100%',
				buttonText: function (options) {
					if (options.length == 0) {
						return '请选择';
					} else {
						var select = '';
						options.each(function () {
							select += $(this).text() + ',';
						});
						return select.substr(0, select.length - 1);
					}
				},
				onChange: function (option, checked) {
					selectedMember = "";
					$('select#add_Member option:selected').each(function (i, item) {
						selectedMember += $(item).val() + ',';
					});
				}
			});
		})

	}
	function multiselectgetMember(suc) {
		// 会员配置
		sendAjax("POST", host_url + "/cloud-web/cusMemberInfo/getAllCusMember", {}, function (data) {
			$('#add_Member').html('');
			$.each(data.rows, function (i, item) {
				var Member = '<option value="' + item.cusCode + '">' + item.cusCode + '(' + item.cusName + ')</option>';
				$('#add_Member').append(Member);
			});
			if (suc) {
				suc();
			}
		})
	}

	//初始化验证框架
	function shift_validateForm() {
		//进行表单验证
		$('#shifts_add_form').bootstrapValidator({
			message: '输入值不合法',
			feedbackIcons: { valid: 'glyphicon glyphicon-ok', invalid: 'glyphicon glyphicon-remove', validating: 'glyphicon glyphicon-refresh' },
			excluded: [':disabled'],
			fields: {
				groupCode: {
					verbose: false,
					message: '财务组长验证失败',
					validators: {
						callback: {
							message: '财务组长不能为空',
							callback: function (value, validator) {
								var cardUseType = $("#add_cardUseType").val();
								if (cardUseType == 20) {
									return true;
								} else {
									if (value) {
										return true;
									} else {
										return false;
									}
								}
							}
						}
					}
				},
				operatorCode: {
					verbose: false,
					message: '财务人员验证失败',
					validators: {
						notEmpty: { message: '财务人员不能为空' }
					}
				},
				acctNo: {
					verbose: false,
					message: '银行卡号验证失败',
					validators: {
						notEmpty: { message: '银行卡号不能为空' }
					}
				},
				/* acctLevel:{
					verbose: false,
					message: '开放量级验证失败',
					validators: {
							notEmpty: {message: '开放量级不能为空'}
					}
				}, */
				amtCode: {
					verbose: false,
					message: '出金限额验证失败',
					validators: {
						notEmpty: { message: '出金限额不能为空' }
					}
				},
				cardUseType: {
					verbose: false,
					message: '账号用途验证失败',
					validators: {
						notEmpty: { message: '账号用途不能为空' }
					}
				}
			}
		});
	}

	//提交
	function _doSubmit() {
		var bv = $('#shifts_add_form').data('bootstrapValidator').validate();
		if (!bv.isValid()) {//验证不通过
			return;
		}
		var acctNoLists = '';
		var paramForm = $("#shifts_add_form").serializeArray();
		var params = {};
		$.each(paramForm, function (i, param) {
			params[param.name] = $.trim(param.value);
		});

		$.each(acctNoList, function (i, item) {
			acctNoLists += item + ',';
		});
		params.acctNoList = acctNoLists.slice(0, acctNoLists.length - 1);
		if (params.acctNoList == "" || $('input[name="acctAdd"]').val() == undefined) {
			Ewin.alert({
				message: '请点击“+”添加此银行信息再保存'
			});
			return;
		}
		delete params.acctNo;
		delete params.acctAdd;

		params.operatorCode = $("#add_operatorCode option:selected").val();
		params.groupCode = $("#add_groupCode option:selected").val();
		params.operatorName = $("#add_operatorCode option:selected").attr('name');
		if (params.groupCode) {
			params.groupName = $("#add_groupCode option:selected").attr('name');
		}
		// params.cardUseType = $('#add_cardUseType option:selected').val();
		params.cardUseType = "20"
		params.routeCode = routeCode;
		params.acctLevel = selectedValue.slice(0, selectedValue.length - 1);

		if (selectedMember) {
			if (selectedMember.split(',').length > 21) {
				Ewin.alert({
					message: '最多可添加20个会员'
				});
				return;
			}

			params.cusList = selectedMember.slice(0, selectedMember.length - 1);
		}


		sendAjax('POST', host_url + "/cloud-web/cardRoutePoolMerch/addSubmit", params, function (res) {
			Ewin.alert({ message: '恭喜你，操作成功！' }).on(function (e) {
				if (e) {
					getAllShiftsLists();
					initData_shift();
					//清空多选框选中代码：
					$('select[multiple="multiple"]').multiselect('clearSelection');
					$('select[multiple="multiple"]').multiselect('refresh');
					$(".bankNo").html('');
					$('#add_cardUseType~.combo-input').val('');
					$('#add_cardUseType~ul li').removeClass('option-selected option-hover');
					$('#add_operatorCode~.combo-input').val('');
					$('#add_operatorCode~ul li').removeClass('option-selected option-hover');
					$('#add_acctNo~.combo-input').val('');
					$('#add_acctNo~ul li').removeClass('option-selected option-hover');
					$('#add_acctLevel~.combo-input').val('');
					$('#add_acctLevel~ul li').removeClass('option-selected option-hover');
					$('#add_groupCode~.combo-input').val('');
					$('#add_groupCode~ul li').removeClass('option-selected option-hover');

				}
			});
		});
	}
</script>