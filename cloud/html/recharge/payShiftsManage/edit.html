<div class="content_center">
	<div class="content_center_content">
		<form class="form-horizontal" name="pay_edit_form" role="form" id="pay_edit_form">
			<div class="form-group">
				<label class="control-label col-xs-4 col-sm-3"><span class="red">*</span>账号用途</label>
				<div class="col-xs-8 col-sm-7">
					<input class="form-control" id="pay_edit_cardUseType" name="cardUseType" readonly />
				</div>
			</div>
			<div class="form-group">
				<label class="control-label col-xs-4 col-sm-3"><span class="red">*</span>财务组长</label>
				<div class="col-xs-8 col-sm-7">
					<select class="form-control" id="pay_edit_groupCode" name="groupCode"></select>
				</div>
			</div>
			<div class="form-group finance">
				<label class="control-label col-xs-4 col-sm-3"><span class="red">*</span>财务人员</label>
				<div class="col-xs-8 col-sm-7">
					<select class="form-control" id="pay_shift_edit_operatorCode" name="operatorCode"></select>
				</div>
			</div>
			<div class="form-group">
				<label class="control-label col-xs-4 col-sm-3"><span class="red">*</span>开放量级</label>
				<div class="col-xs-8 col-sm-7 pay_edit_acctLevel">
					<select class="multiselect multiselectLevel form-control" id="pay_edit_acctLevel" name="acctLevel"
						multiple="multiple"></select>
				</div>
			</div>
			<div class="form-group">
				<label class="control-label col-xs-4 col-sm-3">会员配置</label>
				<div class="col-xs-8 col-sm-7 pay_shifts_edit_Member">
					<select class="multiselect multiselectMember form-control" id="pay_shifts_edit_Member"
						name="cusCode" multiple="multiple"></select>
				</div>
			</div>
			<div class="form-group">
				<label class="control-label col-xs-4 col-sm-3"><span class="red">*</span>银行卡号</label>
				<div class="col-xs-8 col-sm-7">
					<input class="form-control" id="pay_edit_acctNo" name="acctNo" readonly />
				</div>
			</div>
			<div class="bankNo"></div>
		</form>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn btn-default" data-dismiss="modal">
			取消
		</button>
		<button type="button" class="btn btn-primary" onclick="_doSubmit()">
			保存
		</button>
	</div>
</div>
<link rel="stylesheet" href="../../../css/lib/bootstrap-multiselect.css" />
<style>
	.pay_edit_acctLevel .multiselect-container,
	.pay_shifts_edit_Member .multiselect-container {
		width: 100%;
	}
</style>
<script type="text/javascript" src="../../../js/lib/bootstrap-multiselect.js"></script>
<script type="text/javascript">
	var id = "",
		routeCode = "",
		objId,
		psSelectedValue;
	var selectedMember = "";
	$(function () {
		id = getQueryString("id");
		objId = getQueryString("objId");
		routeCode = getQueryString("routeCode");
		psm_getSelectLevelList();
		getPaySelectUserPayList(40);
		getPaySelectUserPayList(52);
		initData_shift();
	});
	function initData_shift() {
		shift_validateForm(); //验证初始化

		sendAjax(
			"POST",
			host_url + "/cloud-web/cardRoutePoolMerch/view",
			{ id: id },
			function (res) {
				var data = res.rows;

				if (data.cardUseType == 10) {
					$("#pay_edit_cardUseType").val("入款卡");
					getPaySelectUserPayList(40);
				} else if (data.cardUseType == 20) {
					$("#pay_edit_cardUseType").val("出款卡");
					getPaySelectUserPayList(60);
				}
				setTimeout(function () {
					$(
						"#pay_edit_groupCode option[value='" +
						data.groupCode +
						"']"
					).attr("selected", "selected");
					$("#pay_edit_groupCode+.combo-input").val(
						$("#pay_edit_groupCode option[selected]").text()
					);
					$("#pay_edit_groupCode").comboSelect();
					$(
						"#pay_shift_edit_operatorCode option[value='" +
						data.operatorCode +
						"']"
					).attr("selected", "selected");
					$("#pay_shift_edit_operatorCode+.combo-input").val(
						$(
							"#pay_shift_edit_operatorCode option[selected]"
						).text()
					);
					$("#pay_shift_edit_operatorCode").comboSelect();
				}, 500);
				setTimeout(function () {
					if (data.acctLevel) {
						psSelectedValue = data.acctLevel + ",";
						// let psm_select_acctLevel=[];
						// $.each(psSelectedValue.split(','),function(i,item){
						// 	if(item != ""){
						// 		psm_select_acctLevel.push(Number(item));
						// 	}
						// })
						$("#pay_edit_acctLevel").multiselect(
							"select",
							data.acctLevel.split(",")
						);
					}
				}, 300);
				new Promise(getMember).then(function () {
					if (data.cusList) {
						selectedMember = data.cusList + ",";
						$("#pay_shifts_edit_Member").multiselect(
							"select",
							data.cusList.split(",")
						);
					}
				});
				$("#pay_edit_acctNo").val(data.acctNo);
			}
		);
	}

	// 获取 组长(50) 或 财务(40) 下拉框
	function getPaySelectUserPayList(role) {
		sendAjax(
			"POST",
			host_url + "/cloud-web/ownSsoUser/selectUserListByRole",
			{ role: role },
			function (res) {
				var data = res.rows;
				var lists = "<option value=''>请选择</option>";
				$.each(data, function (i, item) {
					lists += '<option value="' + item.loginName + '" name="' + item.userName + '" >' + item.loginName + "(" + item.userName + ")" + '</option>';
				});
				if (role == 52) {
					$("#pay_edit_groupCode").html(lists);
					$("#pay_edit_groupCode").comboSelect();
				} else {
					$("#pay_shift_edit_operatorCode").html(lists);
					$("#pay_shift_edit_operatorCode").comboSelect();
				}
			}
		);
	}

	// 获取 开发量级 下拉框
	function psm_getSelectLevelList() {
		new Promise(multiselectLevel).then(function () {
			$(".multiselectLevel").multiselect({
				buttonClass: "btn",
				buttonWidth: "100%",
				buttonText: function (options) {
					if (options.length == 0) {
						return "请选择";
					} else {
						var selected = "";
						options.each(function () {
							selected += $(this).text() + ",";
						});
						return selected.substr(0, selected.length - 1);
					}
				},
				onChange: function (option, checked) {
					psSelectedValue = "";
					$("select#pay_edit_acctLevel option:selected").each(
						function (i, item) {
							psSelectedValue += $(item).val() + ",";
						}
					);
				}
			});
		});
	}
	function multiselectLevel(suc) {
		sendAjax(
			"POST",
			host_url + "/cloud-web/cardBankCardInfo/loadLevel",
			{},
			function (res) {
				var data = res.rows;
				$.each(data, function (i, item) {
					var pay_edit_acctLevel =
						'<option value="' +
						item.keyValue +
						'" data-value="' +
						item.id +
						'">' +
						item.keyName +
						"</option>";
					$("#pay_edit_acctLevel").append(pay_edit_acctLevel);
				});
				if (suc) {
					suc();
				}
			}
		);
	}

	// 获取 会员配置 下拉框
	function getMember(suc) {
		new Promise(multiselectgetPayMember).then(function () {
			$(".multiselectMember").multiselect({
				buttonClass: "btn",
				buttonWidth: "100%",
				buttonText: function (options) {
					if (options.length == 0) {
						return "请选择";
					} else {
						var select = "";
						options.each(function () {
							select += $(this).text() + ",";
						});
						return select.substr(0, select.length - 1);
					}
				},
				onChange: function (option, checked) {
					selectedMember = "";
					$("select#pay_shifts_edit_Member option:selected").each(
						function (i, item) {
							selectedMember += $(item).val() + ",";
						}
					);
				}
			});
			if (suc) {
				suc();
			}
		});
	}
	function multiselectgetPayMember(suc) {
		// 会员配置
		sendAjax(
			"POST",
			host_url + "/cloud-web/cusMemberInfo/getAllCusMember",
			{},
			function (data) {
				$("#pay_shifts_edit_Member").html("");
				$.each(data.rows, function (i, item) {
					var Member =
						'<option value="' +
						item.cusCode +
						'">' +
						item.cusCode +
						"(" +
						item.cusName +
						")</option>";
					$("#pay_shifts_edit_Member").append(Member);
				});
				if (suc) {
					suc();
				}
			}
		);
	}

	// 账号用途 改变
	function changeCardUseType() {
		var cardUseType = $("#pay_edit_cardUseType").val();
		if (cardUseType == 10) {
			getPaySelectUserPayList(40);
		} else if (cardUseType == 20) {
			getPaySelectUserPayList(60);
		}
		if (cardUseType) {
			getSelectBankList();
		}
		$(".bankNo").html("");
	}

	//初始化验证框架
	function shift_validateForm() {
		//进行表单验证
		$("#pay_edit_form").bootstrapValidator({
			message: "输入值不合法",
			feedbackIcons: {
				valid: "glyphicon glyphicon-ok",
				invalid: "glyphicon glyphicon-remove",
				validating: "glyphicon glyphicon-refresh"
			},
			excluded: [":disabled"],
			fields: {
				groupCode: {
					verbose: false,
					message: "财务组长验证失败",
					validators: {
						callback: {
							message: "财务组长不能为空",
							callback: function (value, validator) {
								var cardUseType = $(
									"#pay_edit_cardUseType"
								).val();
								if (cardUseType == 20) {
									return true;
								} else {
									if (value) {
										return true;
									} else {
										return false;
									}
								}
							}
						}
					}
				},
				operatorCode: {
					verbose: false,
					message: "财务人员验证失败",
					validators: {
						notEmpty: { message: "财务人员不能为空" }
					}
				},
				acctNo: {
					verbose: false,
					message: "银行卡号验证失败",
					validators: {
						notEmpty: { message: "银行卡号不能为空" }
					}
				},
				acctLevel: {
					verbose: false,
					message: "开放量级验证失败",
					validators: {
						notEmpty: { message: "开放量级不能为空" }
					}
				},
				cardUseType: {
					verbose: false,
					message: "账号用途验证失败",
					validators: {
						notEmpty: { message: "账号用途不能为空" }
					}
				}
			}
		});
	}

	//提交
	function _doSubmit() {
		var bv = $("#pay_edit_form")
			.data("bootstrapValidator")
			.validate();
		if (!bv.isValid()) {
			//验证不通过
			return;
		}
		var paramForm = $("#pay_edit_form").serializeArray();
		var params = {};
		$.each(paramForm, function (i, param) {
			params[param.name] = $.trim(param.value);
		});
		params.operatorCode = $("#pay_shift_edit_operatorCode option:selected").val();
		params.operatorName = $("#pay_shift_edit_operatorCode option:selected").attr('name');
		params.groupCode = $("#pay_edit_groupCode option:selected").val();
		if (params.groupCode) {
			params.groupName = $("#pay_edit_groupCode option:selected").attr('name');
		}
		params.cardUseType = $("#pay_edit_cardUseType option:selected").val();
		params.routeCode = routeCode;
		params.acctLevel = psSelectedValue.slice(0, psSelectedValue.length - 1);
		params.ids = id;
		delete acctNo;
		delete cardUseType;
		if (selectedMember) {
			if (selectedMember.split(",").length > 21) {
				Ewin.alert({
					message: "最多可添加20个会员"
				});
				return;
			}

			params.cusList = selectedMember.slice(0, selectedMember.length - 1);
		}

		sendAjax(
			"POST",
			host_url + "/cloud-web/cardRoutePoolMerch/batchEditSubmit",
			params,
			function (res) {
				Ewin.alert({ message: "恭喜你，操作成功！" }).on(function (e) {
					if (e) {
						$("#pay_edit_form")
							.parents(".modal")
							.modal("hide");
						payShiftManageSearch(objId);
					}
				});
			}
		);
	}
</script>