<div class="content_center">
	<div class="content_center_content">
		<form class="form-horizontal" name="add_form" role="form" id="add_form">
			<div class="form-group">
				<label class="control-label col-xs-4 col-sm-3"><span class="red">*</span>班次</label>
				<div class="col-xs-8 col-sm-7">
					<select id="workBench_trade_add_routeCode" name="tragetRouteCode"
						onchange="workBench_add_change(this)"></select>
				</div>
			</div>
			<div class="form-group" style="display: none">
				<label class="control-label col-xs-4 col-sm-3"><span class="red">*</span>财务人员</label>
				<div class="col-xs-8 col-sm-7">
					<select id="workBench_tragetOperatorCode" name="tragetOperatorCode"></select>
				</div>
			</div>
		</form>
	</div>
	<div class="modal-footer">
		<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
		<button type="button" class="btn btn-primary" onclick="_doSubmit()">保存</button>
	</div>
</div>
<script type="text/javascript">
	var add_orderNo = getQueryString('orderNo');
	$(function () {
		_validateForm(); //验证初始化
		add_getRouteCode();
	});

	// 获取 班次 列表
	function add_getRouteCode() {
		sendAjax("get", host_url + "/cloud-web/cardRoutePoolInfo/loadRouteCode", {}, function (res) {
			var data = res.rows;
			var str = '<option value="">请选择</option>'
			$.each(data, function (i, item) {
				str += '<option value="'+item.routeCode+'" timeLimit="'+item.timeLimit+'">'+item.routeName+'</option>'
				
			});
			$('#workBench_trade_add_routeCode').html(str).comboSelect();
		})
	}

	function workBench_add_change(obj) {
		var routeCode = $(obj).val();
		if (routeCode) {
			getBankByRouteCode(routeCode);
		} else {
			$("#workBench_tragetOperatorCode").closest(".form-group").hide();
		}
	}

	// 根据班次 获取 财务人员 列表
	function getBankByRouteCode(code) {
		sendAjax("get", host_url + "/cloud-web/cardRoutePoolMerch/loadOperaTorByRouteCode", { 'routeCode': code, 'cardUseType': 20, 'operatorCode': _loginJsonObj.loginName }, function (res) {
			var data = res.rows;
			var str = '<option value="">请选择</option>'
			$.each(data, function (i, item) {
				str += '<option value="'+item.operatorCode+'">'+item.operatorName+'</option>'
			});
			$('#workBench_tragetOperatorCode').html(str).comboSelect();
			$("#workBench_tragetOperatorCode").closest(".form-group").show();
			$('#add_form').data("bootstrapValidator").resetField("tragetOperatorCode");
		})
	}
	//初始化验证框架
	function _validateForm() {
		//进行表单验证
		$('#add_form').bootstrapValidator({
			message: '输入值不合法',
			feedbackIcons: {
				valid: 'glyphicon glyphicon-ok',
				invalid: 'glyphicon glyphicon-remove',
				validating: 'glyphicon glyphicon-refresh'
			},
			excluded: [':disabled'],
			fields: {
				tragetRouteCode: {
					message: '班次验证失败',
					validators: {
						notEmpty: {
							message: '班次不能为空'
						}
					}
				},
				tragetOperatorCode: {
					message: '财务人员验证失败',
					validators: {
						notEmpty: {
							message: '财务人员不能为空'
						}
					}
				}
			}
		});
	}

	//提交
	function _doSubmit() {
		var bv = $('#add_form').data('bootstrapValidator').validate();
		if (!bv.isValid()) { //验证不通过
			return;
		}

		var paramForm = $("#add_form").serializeArray();
		var params = {};
		$.each(paramForm, function (i, param) {
			params[param.name] = $.trim(param.value);
		});
		params.orderNo = add_orderNo;
		params.operatorCode = _loginJsonObj.loginName;

		sendAjax('POST', host_url + "/cloud-web/corePayTransFlow/financeChangeHandler", params, function (res) {
			Ewin.alert({
				message: '恭喜你，操作成功！'
			}).on(function (e) {
				if (e) {
					$('.modal').modal('hide');
					$("#corePayTransFlowTable").bootstrapTable('refresh');
				}
			});
		});
	}
</script>