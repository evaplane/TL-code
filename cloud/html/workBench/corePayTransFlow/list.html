<link rel="stylesheet" href="../../../css/lib/daterangepicker-bs3.css">
<link rel="stylesheet" href="../../../css/lib/bootstrap-table.min.css" />
<div class="content_center">
	<div class="content_center_content">
		<!--查询条件-->
		<div class="content_center_condition">
			<form id="corePayTransFlowForm" name="queryForm" role="form" class="form-inline">
				<div class="form-group">
					<label class="control-label">用户名：</label>
					<input name="userAcct" class="form-control" type="text" placeholder="用户名" autocomplete="off">
				</div>
				<div class="form-group">
					<label class="control-label">真实姓名：</label>
					<input type="text" name="userName" class="form-control" type="text" placeholder="真实姓名"
						autocomplete="off">
				</div>
				<div class="form-group">
					<label class="control-label">平台号：</label>
					<input name="customerNo" class="form-control" type="text" placeholder="平台号" autocomplete="off">
				</div>
				<div class="form-group">
					<label class="control-label">平台名称：</label>
					<input name="customerName" class="form-control" type="text" placeholder="平台名称" autocomplete="off">
				</div>
				<div class="form-group">
					<label class="control-label">客户单号：</label>
					<input name="cusOrderNo" class="form-control" type="text" placeholder="客户单号" autocomplete="off">
				</div>
				<div class="form-group">
					<label class="control-label">平台流水号：</label>
					<input type="text" name="orderNo" class="form-control" type="text" placeholder="平台流水号"
						autocomplete="off">
				</div>
				<div class="form-group">
					<label class="control-label">提款卡号：</label>
					<input type="text" name="recAcctNo" class="form-control" type="text" placeholder="提款卡号"
						autocomplete="off">
				</div>
				<div class="form-group">
					<label class="control-label">提款户名：</label>
					<input type="text" name="recAcctName" class="form-control" type="text" placeholder="提款户名"
						autocomplete="off">
				</div>
				<div class="form-group">
					<label class="control-label">创建时间：</label>
					<input type="text" name="createTime" id="corePayTransFlow_createTime"
						class="form-control dateranges" placeholder="创建时间" autocomplete="off" readonly="readonly" />
				</div>
				<div class="form-group">
					<button id="corePayTransFlow_button" type="button" class="btn btn-primary refreshBtn"><i
							class="fa fa-search"></i>查询</button>
					<button type="reset" class="btn btn-default"><i class="fa fa-refresh"></i> 重置</button>
				</div>
				<div class="clearfix"></div>
			</form>
		</div>
		<div class="content_center_table">
			<p class="marginBottom">
				总笔数：<span class="transFlowTotalCount"></span>笔 总金额：<span class="transFlowTotalAmt"></span>元
			</p>
			<table cellpadding="0" cellspacing="0" border="0" id="corePayTransFlowTable"
				class="table table-bordered table-hover"></table>
		</div>
	</div>
</div>
<style type="text/css">
	#corePayTransFlowTable.table {
		width: 3000px;
	}
</style>
<script>
	$(function () {
		corePayTransFlowTable();
		window.setInterval(function () {
			$("#corePayTransFlowTable").bootstrapTable('refresh');
		}, 30000);
		
		var firstDay = sys_formatDate(new Date().setDate(1)) + ' 00:00:00';
		var lastDay = getCurrentMonthLast() + ' 23:59:59';
		$('#corePayTransFlow_createTime').daterangepicker({
			timePicker: true,
			timePickerIncrement: 1,
			format: 'YYYY-MM-DD HH:mm:ss',
			startDate: firstDay,
			endDate: lastDay,
			opens: 'center',
		
		}, function (start, end, label) {
		
		});
	});
	// 搜索
	$("#corePayTransFlow_button").click(function () {
		var payAcceptTime = $('#corePayTransFlow_createTime').val();
		if (payAcceptTime != '') {
			payAcceptTimestart = payAcceptTime.split(' - ')[0];
			payAcceptTimeEnd = payAcceptTime.split(' - ')[1];
		
			var start = parserDate(payAcceptTimestart),
				end = parserDate(payAcceptTimeEnd);
			if(start.getFullYear() != end.getFullYear()){
				Ewin.alert({
					message: "暂不支持跨年查询"
				});
				return;
			}else if (start.getMonth()+1 != end.getMonth()+1) {
				Ewin.alert({
					message: "暂不支持跨月查询"
				});
				return;
			}
		}
		$("#corePayTransFlowTable").bootstrapTable('refresh');
	});
	// 总笔数等信息
	function transFlowTotalInfo() {
		let paramForm = $("#corePayTransFlowForm").serializeArray();
		let params = {};
		$.each(paramForm, function (i, param) {
			params[param.name] = $.trim(param.value);
		});
		if (params.createTime) {
			params.startTime = params.createTime.substring(0, 19);
			params.endTime = params.createTime.substring(21, 41);
		}
		delete params.createTime;
		sendAjax('POST', host_url + "/cloud-web/corePayTransFlow/workRealTimeStatis", params, function (res) {
			let data = res.rows;
			if (data == '') {
				$(".transFlowTotalCount").html('0');
				$(".transFlowTotalAmt").html(formatterMoney('0'));
			} else {
				$(".transFlowTotalCount").html(data.totalCount);
				if (data.totalAmt) {
					$(".transFlowTotalAmt").html(formatterMoney(data.totalAmt));
				} else {
					$(".transFlowTotalAmt").html(formatterMoney('0'));
				}
			}
		});
	}
	/*表格加载*/
	function corePayTransFlowTable() {
		$('#corePayTransFlowTable').bootstrapTable({
			url: host_url + '/cloud-web/corePayTransFlow/workList',
			method: 'GET',
			dataType: "json",
			contentType: "application/x-www-form-urlencoded;charset=UTF-8",
			pagination: true, //在表格底部显示分页工具栏  
			pageNumber: 1,
			pageList: [20, 50, 100],
			clickToSelect: true,
			sidePagination: "server", //表格分页的位置
			cache: false, //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
			locale: 'zh-CN', //中文支持
			queryParamsType: 'limit',
			queryParams: function (params) {
				params.pageSize = params.limit; //页面大小
				params.page = (params.offset / params.limit) + 1; //页码
				params._sys_login_token = _get_sys_login_token();
				var paramForm = $("#corePayTransFlowForm").serializeArray();
				$.each(paramForm, function (i, param) {
					params[param.name] = $.trim(param.value);
				});
				params.operatorCode = JSON.parse(localStorage.getItem("sybJsonLocal")).loginName;
				params.status = 20;
				if (params.createTime) {
					params.startTime = params.createTime.substring(0, 19);
					params.endTime = params.createTime.substring(21, 41);
				}
				delete params.createTime;
				return params;
			}, //参数  
			columns: [{
				title: '序号',
				// checkbox: true,
				width: 30,
				align: "center",
				valign: "middle",
				formatter: function (value, row, index) {
					var options = $('#corePayTransFlowTable').bootstrapTable("getOptions");
					return (options.pageNumber - 1) * (options.pageSize) + index + 1;
				}
			},
			{
				title: '操作',
				field: 'operation',
				align: "center",
				valign: "middle",
				width: 50,
				formatter: function (value, row, index) {
					return '<a class="glyphicon glyphicon-lock" style="margin-right:10px;" onclick="corePayHandle(\'' + row.id + '\',\'' + row.routeCode + '\',\'' + row.operatorCode
					  +'\',\'' + row.userName+'\',\'' + row.userAcct+'\',\'' + row.payAmt+ '\')" title="办理"></a> ' +
						'<a class="glyphicon glyphicon-random" onclick="corePayTransFlow_direcOdr(\'' + row.id + '\',\'' + row.orderNo + '\')" title="订单转交"></a> ';
				}
			},
			{
				field: 'payAmt',
				title: '提款金额(元)',
				width: 30,
				align: "right",
				valign: "middle",
				formatter: function (value, row, index) {
					return formatterMoney_edit(value)
				}
			},
			{
				field: 'orderAmt',
				title: '订单金额(元)',
				width: 30,
				align: "right",
				valign: "middle",
				formatter: function (value, row, index) {
					return formatterMoney_edit(value)
				}
			},
			{ field: 'customerName', title: '平台名称', width: 100, align: "center", valign: "middle" },
			{
				field: 'userAcct',
				title: '用户名',
				width: 100,
				align: "center",
				valign: "middle"
			},
			{
				field: 'recBankName',
				title: '提款银行',
				width: 100,
				align: "center",
				valign: "middle"
			},
			{
				field: 'createTime',
				title: '创建时间',
				width: 150,
				align: "center",
				valign: "middle",
				formatter: function (value, row, index) {
					return getDateStr(value);
				}
			},
			{
				field: 'cusOrderNo',
				title: '客户单号',
				width: 150,
				align: "center",
				valign: "middle"
			},
			{
				field: 'userName',
				title: '真实姓名',
				width: 100,
				align: "center",
				valign: "middle"
			},
			{ field: 'customerNo', title: '平台号', width: 100, align: "center", valign: "middle" },
			{
				field: 'recAcctNo',
				title: '提款卡号',
				width: 150,
				align: "center",
				valign: "middle"
			},
			{
				field: 'recAcctName',
				title: '提款户名',
				width: 100,
				align: "center",
				valign: "middle"
			},
			{
				field: 'orderNo',
				title: '平台流水号',
				width: 150,
				align: "center",
				valign: "middle"
			},
			{
				field: 'recProvinceName',
				title: '开户地址',
				width: 100,
				align: "center",
				valign: "middle",
				formatter: function (value, row, index) {
					return row.recProvinceName + row.recCityName;
				}
			},
			{
				field: 'recSubBankName',
				title: '开户支行',
				width: 100,
				align: "center",
				valign: "middle"
			},
			{ field: 'routeName', title: '班次名称', width: 70, align: "center", valign: "middle" },
			],
			onClickRow: function (row, $element) {
				$($element).addClass('table_info').siblings().removeClass('table_info');
			},
			onLoadSuccess: function (res) {
				//加载成功时执行  
				transFlowTotalInfo();
			},
		});
	}

	//办理
	var workBench_trans_add_routeCode = "";
	var workBench_trans_add_operatorCode = "";
	function corePayHandle(id, routeCode, operatorCode,userName,userAcct,payAmt) {
		workBench_trans_add_routeCode = routeCode;
		workBench_trans_add_operatorCode = operatorCode;
		debugger
		Ewin.dialog({
			// url: '../../../html/workBench/corePayTransFlow/add.html?userName='+userName+'&userAcct='+userAcct+'&payAmt='+payAmt,
			url: '../../../html/workBench/corePayTransFlow/add.html?id='+id,
			title: '提款办理'
		});
	}
	// 订单转交
	function corePayTransFlow_direcOdr(id, orderNo) {
		Ewin.dialog({
			url: '../../../html/workBench/corePayTransFlow/orderForward.html?orderNo=' + orderNo,
			title: '订单转交'
		});

	}
</script>