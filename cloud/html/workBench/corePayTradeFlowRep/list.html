<link rel="stylesheet" href="../../../css/lib/bootstrap-table.min.css" />
<link rel="stylesheet" href="../../../css/lib/daterangepicker-bs3.css">
<div class="content_center">
	<div class="content_center_content">
		<!--查询条件-->
		<div class="content_center_condition">
			<form id="corePayTradeRepFlowForm" name="queryForm" role="form" class="form-inline">
				<div class="form-group">
					<label class="control-label">用户名：</label>
					<input name="userAcct" class="form-control" type="text" placeholder="用户名" autocomplete="off" />
				</div>
				<div class="form-group">
					<label class="control-label">真实姓名：</label>
					<input name="userName" class="form-control" type="text" placeholder="真实姓名" autocomplete="off" />
				</div>
				<div class="form-group">
					<label class="control-label">账户别名：</label>
					<input type="text" name="userAliasName" class="form-control" type="text" placeholder="账户别名"
						autocomplete="off" />
				</div>
				<div class="form-group">
					<label class="control-label">平台号：</label>
					<input name="customerNo" class="form-control" type="text" placeholder="平台号" autocomplete="off" />
				</div>
				<div class="form-group">
					<label class="control-label">平台名称：</label>
					<input name="customerName" class="form-control" type="text" placeholder="平台名称" autocomplete="off" />
				</div>
				<div class="form-group">
					<label class="control-label">客户单号：</label>
					<input name="cusOrderNo" class="form-control" type="text" placeholder="客户单号" autocomplete="off" />
				</div>
				<div class="form-group">
					<label class="control-label">平台流水号：</label>
					<input type="text" name="orderNo" class="form-control" type="text" placeholder="平台流水号"
						autocomplete="off" />
				</div>
				<div class="form-group">
					<label class="control-label">创建时间：</label>
					<input type="text" name="createTime" id="corePayTradeRepFlowForm_createTime"
						class="form-control dateranges" placeholder="创建时间" autocomplete="off" readonly="readonly" />
				</div>
				<div class="form-group">
					<button id="corePayTradeRepFlowForm_button" type="button" class="btn btn-primary refreshBtn">
						<i class="fa fa-search"></i> 查询
					</button>
					<button type="reset" class="btn btn-default">
						<i class="fa fa-refresh"></i> 重置
					</button>
				</div>
				<div class="clearfix"></div>
			</form>
		</div>
		<div class="content_center_table">
			<p class="marginBottom marginTop">
				总笔数：<span class="tradeFlowTotalCountRep"></span>笔
				总金额：<span class="tradeFlowTotalAmtRep"></span>元
			</p>

			<table cellpadding="0" cellspacing="0" border="0" id="corePayTradeRepFlowFormTable"
				class="table table-bordered table-hover"></table>
		</div>
	</div>
</div>
<style type="text/css">
	#corePayTradeRepFlowFormTable.table {
		width: 2500px;
	}
</style>
<script>
	var tradeTypeList;
	var level;
	$(function () {
		// 存款方式
		findConstantValue("Core", "pay_type");
		sendAjax(
			"get",
			host_url + "/cloud-web/cardBankCardInfo/loadVirAcctLevel",
			{},
			function (res) {
				if (res.retCode == "000000") {
					if (res.rows) {
						level = res.rows.paramValue;
					}
				}
			}
		);
		setTimeout(function () {
			tradeTypeList = lists;
			$.each(tradeTypeList, function (i, item) {
				$("#payType_select").append(
					'<option value="' + item.id + '">' + item.text + "</option>"
				);
			});
			$("#payType_select").comboSelect();
			corePayTradeRepFlowFormTable();
		}, 500);
		window.setInterval(function () {
			$("#corePayTradeRepFlowFormTable").bootstrapTable("refresh");
		}, 30000);
		
		
		var firstDay = sys_formatDate(new Date().setDate(1)) + ' 00:00:00';
		var lastDay = getCurrentMonthLast() + ' 23:59:59';
		$('#corePayTradeRepFlowForm_createTime').daterangepicker({
			timePicker: true,
			timePickerIncrement: 1,
			format: 'YYYY-MM-DD HH:mm:ss',
			startDate: firstDay,
			endDate: lastDay,
			opens: 'center',
		
		}, function (start, end, label) {
		
		});
	});
	// 搜索
	$("#corePayTradeRepFlowForm_button").click(function () {
		var payAcceptTime = $('#corePayTradeRepFlowForm_createTime').val();
		if (payAcceptTime != '') {
			payAcceptTimestart = payAcceptTime.split(' - ')[0];
			payAcceptTimeEnd = payAcceptTime.split(' - ')[1];
		
			var start = parserDate(payAcceptTimestart),
				end = parserDate(payAcceptTimeEnd);
			if(start.getFullYear() != end.getFullYear()){
				Ewin.alert({
					message: "暂不支持跨年查询"
				});
				return;
			}else if (start.getMonth()+1 != end.getMonth()+1) {
				Ewin.alert({
					message: "暂不支持跨月查询"
				});
				return;
			}
		}
		$("#corePayTradeRepFlowFormTable").bootstrapTable("refresh");
	});
	// 总笔数等信息
	function tradeFlowTotalInfoRep() {
		var paramForm = $("#corePayTradeRepFlowForm").serializeArray();
		var params = {};
		$.each(paramForm, function (i, param) {
			params[param.name] = $.trim(param.value);
		});
		params.userLevel = level;
		if (params.createTime) {
			params.startTime = params.createTime.substring(0, 19);
			params.endTime = params.createTime.substring(21, 41);
		}
		delete params.createTime;
		sendAjax(
			"POST",
			host_url + "/cloud-web/corePayTradeFlow/workRealTimeStatis",
			params,
			function (res) {
				var data = res.rows;
				if (data == "") {
					$(".tradeFlowTotalCountRep").html("0");
					$(".tradeFlowTotalAmtRep").html(formatterMoney("0"));
				}

				$(".tradeFlowTotalCountRep").html(data.totalCount);
				if (data.totalAmt) {
					$(".tradeFlowTotalAmtRep").html(
						formatterMoney(data.totalAmt)
					);
				} else {
					$(".tradeFlowTotalAmtRep").html(formatterMoney("0"));
				}
			}
		);
	}
	/*表格加载*/
	function corePayTradeRepFlowFormTable() {
		$("#corePayTradeRepFlowFormTable").bootstrapTable({
			url: host_url + "/cloud-web/corePayTradeFlow/workList",
			method: "GET",
			dataType: "json",
			contentType: "application/x-www-form-urlencoded;charset=UTF-8",
			pagination: true, //在表格底部显示分页工具栏
			pageNumber: 1,
			pageList: [20, 50, 100],
			clickToSelect: true,
			sidePagination: "server", //表格分页的位置
			cache: false, //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
			locale: "zh-CN", //中文支持
			queryParamsType: "limit",
			queryParams: function (params) {
				params.pageSize = params.limit; //页面大小
				params.page = params.offset / params.limit + 1; //页码
				params._sys_login_token = _get_sys_login_token();
				var paramForm = $("#corePayTradeRepFlowForm").serializeArray();
				$.each(paramForm, function (i, param) {
					params[param.name] = $.trim(param.value);
				});
				params.operatorCode = JSON.parse(
					localStorage.getItem("sybJsonLocal")
				).loginName;
				params.userLevel = level;
				if (params.createTime) {
					params.startTime = params.createTime.substring(0, 19);
					params.endTime = params.createTime.substring(21, 41);
				}
				delete params.createTime;
				return params;
			}, //参数
			columns: [
				{
					title: "序号",
					field: "index",
					width: 40,
					align: "center",
					valign: "middle",
					formatter: function (value, row, index) {
						var pageSize = $(
							"#corePayTradeRepFlowFormTable"
						).bootstrapTable("getOptions").pageSize;
						var pageNumber = $(
							"#corePayTradeRepFlowFormTable"
						).bootstrapTable("getOptions").pageNumber;
						return pageSize * (pageNumber - 1) + index + 1;
					}
				},
				{
					title: "操作",
					field: "operation",
					align: "center",
					valign: "middle",
					width: 60,
					formatter: function (value, row, index) {
						return (
							'<a  class="glyphicon glyphicon-lock" title="办理" onclick="workBench_trade_list_edit_rep(\'' +
							row.id +
							"','" +
							row.orderNo + '\',\'' + row.userName + '\',\'' + row.userAcct + '\',\'' + row.payAmt +
							"')\"></a> "
						);
					}
				},
				{
					field: "customerName",
					title: "平台名称",
					width: 100,
					align: "center",
					valign: "middle"
				},
				{
					field: "userAcct",
					title: "用户名",
					width: 100,
					align: "center",
					valign: "middle"
				},
				{
					field: "userName",
					title: "真实姓名",
					width: 100,
					align: "center",
					valign: "middle"
				},
				{
					field: "userAliasName",
					title: "账户别名",
					width: 80,
					align: "center",
					valign: "middle"
				},
				{
					field: "orderAmt",
					title: "订单金额(元)",
					width: 100,
					align: "right",
					valign: "middle",
					formatter: function(value, row, index) {
						return formatterMoney(value, 2);
					}
				},
				{
					field: "payAmt",
					title: "存款金额(元)",
					width: 100,
					align: "right",
					valign: "middle",
					formatter: function (value, row, index) {
						return formatterMoney(value, 2);
					}
				},
				{
					field: "payAcctName",
					title: "存款人",
					width: 70,
					align: "center",
					valign: "middle"
				},
				{
					field: "userLevel",
					title: "用户星级",
					width: 100,
					align: "center",
					valign: "middle",
					formatter: function (value, row, index) {
						return value + "星";
					}
				},
				{
					field: "createTime",
					title: "创建时间",
					width: 150,
					align: "center",
					valign: "middle",
					formatter: function (value, row, index) {
						return getDateStr(value);
					}
				},
				{
					field: "payType",
					title: "存款方式",
					width: 100,
					align: "center",
					valign: "middle",
					formatter: function (value, row, index) {
						return visualParams(tradeTypeList, value);
					}
				},
				{
					field: "customerNo",
					title: "平台号",
					width: 100,
					align: "center",
					valign: "middle"
				},
				{
					field: "cusOrderNo",
					title: "客户单号",
					width: 170,
					align: "center",
					valign: "middle"
				},
				{
					field: "orderNo",
					title: "平台流水号",
					width: 175,
					align: "center",
					valign: "middle"
				},
				{
					field: "recAcctNo",
					title: "收款卡号",
					width: 150,
					align: "center",
					valign: "middle"
				},
				{
					field: "recBankName",
					title: "收款银行",
					width: 100,
					align: "center",
					valign: "middle"
				},
				{
					field: "recSubBankName",
					title: "支行名称",
					width: 100,
					align: "center",
					valign: "middle",
					formatter: function (value, row, index) {
						if (value == "") {
							return "-";
						} else {
							return value;
						}
					}
				},
				{
					field: "routeName",
					title: "班次名称",
					width: 100,
					align: "center",
					valign: "middle"
				},
				{
					field: "recAcctName",
					title: "收款账号",
					width: 100,
					align: "center",
					valign: "middle"
				},
				{
					field: "recRemark",
					title: "银行附言",
					width: 100,
					align: "center",
					valign: "middle"
				}
			],
			onClickRow: function (row, $element) {
				$($element)
					.addClass("table_info")
					.siblings()
					.removeClass("table_info");
			},
			onLoadSuccess: function (res) {
				tradeFlowTotalInfoRep();
			}
		});
	}

	//编辑
	function workBench_trade_list_edit_rep(id, orderNo, userName, userAcct, payAmt) {
		sendAjax(
			"post",
			host_url + "/cloud-web/corePayTradeFlow/checkFinanceMan",
			{ orderNo: orderNo },
			function (res) {
				Ewin.dialog({
					url:
						"../../../html/workBench/corePayTradeFlowRep/edit.html?id=" + id,
					title: "入款补单"
				});
			}
		);
	}
</script>