<link rel="stylesheet" href="../../../css/lib/daterangepicker-bs3.css">
<div class="content_center">
	<div class="content_center_content">
		<!--查询条件-->
		<div class="content_center_condition">
            <form id="queryPushOrderForm" name="queryForm" role="form" class="form-inline">
                <div class="form-group">
                    <label class="control-label">平台号：</label>
                    <input name="cusCode" class="form-control" type="text" placeholder="平台号" autocomplete="off">
                </div>
                <div class="form-group">
                    <label class="control-label">平台名称：</label>
                    <input name="cusName" class="form-control" type="text" placeholder="平台名称" autocomplete="off">
                </div>
                <div class="form-group">
                    <label class="control-label">平台流水号：</label>
                    <input name="orderNo" class="form-control" type="text" placeholder="平台流水号" autocomplete="off">
                </div>
                <div class="form-group">
					<label class="control-label">推送状态：</label>
					<select name="status" id="pushStatus">
						<option value="">全部</option>
						<option value="10">待推送</option>
						<option value="100">推送成功</option>
						<option value="-100">推送失败</option>
					</select>
				</div>
				<div class="form-group">
					<label class="control-label">创建时间：</label>
					<input type="text" name="createTime" id="pushOrder_createTime" class="form-control dateranges" placeholder="创建时间" autocomplete="off" readonly="readonly" />
				</div>
                <div class="form-group pull-right">
                	<button id="PushOrderButton" type="button" class="btn btn-primary refreshBtn"><i class="fa fa-search"></i> 查询</button>
					<button type="button" class="btn btn-default" onclick="PushOrderReset()"><i class="fa fa-refresh"></i> 重置</button>
                </div>
                <div class="clearfix"></div>
            </form>
        </div>
        <div class="content_center_table">
        	<table cellpadding="0" cellspacing="0" border="0" id="PushOrderTable" class="table table-bordered table-hover"></table>
        </div>
    </div>
</div>
    <input type="hidden" id="isOpenScan" />
    <input type="hidden" id="isOpenTrans" />
<script type="text/javascript">
    $(function() {
    	initDate();
        PushOrderTable();
    });
    
    function initDate(){
    	$('#pushStatus').comboSelect();
		var firstDay = sys_formatDate(new Date().setDate(1))+' 00:00:00';
		var lastDay = getCurrentMonthLast() + ' 23:59:59';
		$('#pushOrder_createTime').val(firstDay + ' - ' + lastDay);
		$('#pushOrder_createTime').daterangepicker({
			timePicker: true,
			timePickerIncrement: 1,
			format: 'YYYY-MM-DD HH:mm:ss',
			startDate: firstDay,
			endDate: lastDay,
			opens: 'center',
		
		}, function (start, end, label) {
		
		});	
    }
    
	// 重置
	function PushOrderReset() {
		$("#queryPushOrderForm")[0].reset();
		var firstDay = sys_formatDate(new Date().setDate(1))+' 00:00:00';
		var lastDay = getCurrentMonthLast() + ' 23:59:59';
		$('#pushOrder_createTime').val(firstDay + ' - ' + lastDay);
	}
	// 搜索
    $("#PushOrderButton").click(function() {
		var payAcceptTime = $('#pushOrder_createTime').val();
		if (payAcceptTime != '') {
			payAcceptTimestart = payAcceptTime.split(' - ')[0];
			payAcceptTimeEnd = payAcceptTime.split(' - ')[1];
			
			var start = parserDate(payAcceptTimestart),
				end = parserDate(payAcceptTimeEnd);
			if(start.getFullYear() != end.getFullYear()){
				Ewin.alert({
					message: "暂不支持跨年查询"
				});
				return;
			}else if (start.getMonth()+1 != end.getMonth()+1) {
				Ewin.alert({
					message: "暂不支持跨月查询"
				});
				return;
			}
		}
		
        $('#PushOrderTable').bootstrapTable('refresh');
    });
    /*表格加载*/
    function PushOrderTable() {
        $('#PushOrderTable').bootstrapTable({
            url: host_url + '/cloud-web/coreOrderPushFlow/pageList',
            method: 'GET',
            dataType: "json",
            contentType: "application/x-www-form-urlencoded;charset=UTF-8",
            pagination: true, //在表格底部显示分页工具栏  
            pageNumber: 1,
            pageList: [20, 50, 100],
            clickToSelect: true,
            sidePagination: "server", //表格分页的位置  
            cache: false, //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
            locale: 'zh-CN', //中文支持
            queryParamsType: 'limit',
            queryParams: function(params) {
                params.pageSize = params.limit; //页面大小
                params.page = (params.offset / params.limit) + 1; //页码
                params._sys_login_token = _get_sys_login_token(); //请求token
                
                var paramForm = $("#queryPushOrderForm").serializeArray();
                $.each(paramForm, function(i, param) {
                    params[param.name] = $.trim(param.value);
                });
				if (params.createTime) {
					params.startTime = params.createTime.substring(0, 19);
					params.endTime = params.createTime.substring(21, 41);
				}
				delete params.createTime;
                return params;
            }, //参数  
            columns: [{
				title: '序号',
				field: 'index',
				width: 30,
				align: "center",
				valign: "middle",
				formatter: function (value, row, index) {
					var options = $('#PushOrderTable').bootstrapTable("getOptions");
						return (options.pageNumber - 1) * (options.pageSize) + index + 1;
				}
            }, {
                title: '操作',
                field: 'operation',
                align: "center",
                valign: "middle",
                width: 30,
                formatter: function(value, row, index) {
                    return '<a class="fa operation a_size" onclick="PushOrderTable_resend(\'' + row.id + '\')" title="再次推送"><img width="15px" src="../../../img/s.png"></a> ';
                }
            }, 
            {field:'tradeType',title:'交易类型',width:50,align:"center",valign:"middle",
                formatter: function(value,row) {
					return value == 10 ? '入款' : '提款';
                }},
            {field:'cusCode',title:'平台号',width:80,align:"center",valign:"middle"},
			{field:'cusName',title:'平台名称',width:80,align:"center",valign:"middle"},
			{field:'orderNo',title:'平台流水号',width:100,align:"center",valign:"middle"},
			{field:'returnCode',title:'返回码',width:80,align:"center",valign:"middle"},
			{field:'returnMsg',title:'返回描述',width:150,align:"center",valign:"middle"},
			{field:'status',title:'状态',width:60,align:"center",valign:"middle",
                formatter: function(value,row) {
                	if(value == 10){
                		return "待推送";
                	}
					return value == 100 ? '推送成功' : '推送失败';
                }},
            {field:'pushNum',title:'推送次数',width:80,align:"center",valign:"middle"},
			{field:'createTime',title:'创建时间',width:100,align:"center",valign:"middle",
                formatter: function(value,row) {
                	return formatterDateTime(value);
                }},
			{field:'updateTime',title:'更新时间',width:100,align:"center",valign:"middle",
                formatter: function(value,row) {
					return formatterDateTime(value);
                }}],
			onDblClickRow: function (res) {
				PushOrderTable_view(res.id);
			},
            onClickRow: function(row, $element) {
                $($element).addClass('table_info').siblings().removeClass('table_info');
            },
        });
    }

    //编辑
    function PushOrderTable_resend(id) {
    	Ewin.confirm({
            message: '是否重新推送？'
        }).on(function(e) {
            if (e) { //成功
                sendAjax('POST', host_url + "/cloud-web/coreOrderPushFlow/reSend", {
                    'id': id
                }, function(res) {
                    Ewin.alert({
                        message: '恭喜你，操作成功！'
                    }).on(function(e) {
                        if (e) {
                            //重新加载
                            $("#PushOrderTable").bootstrapTable('refresh');
                        }
                    });
                });
            }
        });
    }

    //详情
    function PushOrderTable_view(id) {
        Ewin.dialog({
            url: '../../system/pushOrder/view.html?id=' + id,
            title: '详情',
            width: 950
        });
    }

</script>